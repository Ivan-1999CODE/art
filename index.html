<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文單字冒險 (Unit 7 - 9)</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
    
    <style>
        /* 避免載入時閃爍 */
        body { opacity: 0; transition: opacity 0.5s; }
        body.loaded { opacity: 1; }
        
        /* 針對 iOS Safari 的一些優化 */
        * { -webkit-tap-highlight-color: transparent; }
        
        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        
        /* 拼字動畫 */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>
<body class="bg-sky-50">
    <div id="root"></div>

    <!-- 這裡開始是 React 程式碼 -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            BookOpen, Gamepad2, LayoutList, Layers, Volume2, ChevronLeft, ChevronRight, 
            CheckCircle, XCircle, Trophy, Star, Sparkles, HelpCircle, RefreshCw, Library, 
            Puzzle, Lightbulb, Music, Map, Wand2, Flag, AlertCircle, ArrowDownLeft, 
            Shuffle, GraduationCap, PenTool, Coffee, Keyboard, MousePointerClick, Filter
        } from 'lucide-react';

        // --- 語音合成優化修正 ---
        let availableVoices = [];
        
        const loadVoices = () => {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                availableVoices = voices;
            }
        };

        loadVoices();
        if (window.speechSynthesis && window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        const speakText = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            let selectedVoice = availableVoices.find(v => 
                (v.lang === 'en-US' || v.lang === 'en_US') && !v.name.includes("Network")
            );
            if (!selectedVoice) {
                selectedVoice = availableVoices.find(v => v.lang.includes('en'));
            }
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            utterance.pitch = 1;
            window.speechSynthesis.speak(utterance);
        };

        // --- 工具函式 ---
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // --- 資料庫 (Unit 7, 8, 9) ---
        const UNITS_DATA = {
            unit7: {
                title: "Unit 7",
                vocab: [
                    { id: "u7-1", word: "triumph", part: "n.", chinese: "勝利；成就；喜悅", sentence: "The team celebrated their triumph with a party.", sentence_ch: "團隊開派對慶祝他們的勝利。" },
                    { id: "u7-2", word: "apply", part: "vi.", chinese: "申請；報名", sentence: "She applied for the job yesterday.", sentence_ch: "她昨天申請了那份工作。" },
                    { id: "u7-3", word: "instrument", part: "n.", chinese: "樂器；儀器", sentence: "Do you play any musical instrument?", sentence_ch: "你會演奏任何樂器嗎？" },
                    { id: "u7-4", word: "somehow", part: "adv.", chinese: "以某種方式；不知怎麼地", sentence: "We will finish the work somehow.", sentence_ch: "我們總會有辦法完成工作的。" },
                    { id: "u7-5", word: "barely", part: "adv.", chinese: "幾乎不", sentence: "I can barely hear you.", sentence_ch: "我幾乎聽不到你的聲音。" },
                    { id: "u7-6", word: "invaluable", part: "adj.", chinese: "非常寶貴的", sentence: "Your help was invaluable to us.", sentence_ch: "你的幫助對我們來說非常寶貴。" },
                    { id: "u7-7", word: "encouragement", part: "n.", chinese: "鼓勵；鼓舞", sentence: "She needs some encouragement now.", sentence_ch: "她現在需要一些鼓勵。" },
                    { id: "u7-8", word: "concert", part: "n.", chinese: "音樂會", sentence: "The concert starts at 7 PM.", sentence_ch: "音樂會在晚上七點開始。" },
                    { id: "u7-9", word: "receive", part: "vt.", chinese: "收到；獲得", sentence: "Did you receive my email?", sentence_ch: "你有收到我的電子郵件嗎？" },
                    { id: "u7-10", word: "dazzle", part: "vt.", chinese: "使讚嘆；使傾倒", sentence: "The dancer dazzled the audience.", sentence_ch: "舞者讓觀眾讚嘆不已。" },
                    { id: "u7-11", word: "potential", part: "n./adj.", chinese: "潛力；潛在的", sentence: "That student has great potential.", sentence_ch: "那位學生有很大的潛力。" },
                    { id: "u7-12", word: "scream", part: "n./vi.", chinese: "尖叫", sentence: "Don't scream in the library.", sentence_ch: "不要在圖書館尖叫。" },
                    { id: "u7-13", word: "dizzy", part: "adj.", chinese: "頭暈目眩的", sentence: "I feel a bit dizzy today.", sentence_ch: "我今天覺得有點頭暈。" },
                    { id: "u7-14", word: "overseas", part: "adv./adj.", chinese: "在海外；海外的", sentence: "They plan to travel overseas.", sentence_ch: "他們計畫去海外旅遊。" },
                    { id: "u7-15", word: "determination", part: "n.", chinese: "決心", sentence: "He showed great determination.", sentence_ch: "他展現了極大的決心。" },
                    { id: "u7-16", word: "faith", part: "n.", chinese: "信心；信念", sentence: "Have faith in yourself.", sentence_ch: "對你自己要有信心。" },
                    { id: "u7-17", word: "pursue", part: "vt.", chinese: "追求；從事", sentence: "You should pursue your dreams.", sentence_ch: "你應該追求你的夢想。" },
                    { id: "u7-18", word: "tons of", part: "phr.", chinese: "大量；許多", sentence: "He has tons of money.", sentence_ch: "他有很多錢。" },
                    { id: "u7-19", word: "look for", part: "phr.", chinese: "尋找", sentence: "I am looking for my keys.", sentence_ch: "我正在找我的鑰匙。" },
                    { id: "u7-20", word: "make a living", part: "phr.", chinese: "謀生", sentence: "It is hard to make a living as an artist.", sentence_ch: "當藝術家很難謀生。" },
                    { id: "u7-21", word: "look forward to", part: "phr.", chinese: "期待", sentence: "I look forward to meeting you.", sentence_ch: "我很期待見到你。" },
                    { id: "u7-22", word: "get carried away", part: "phr.", chinese: "陶醉；激動得無法自持", sentence: "Don't get carried away by success.", sentence_ch: "不要因為成功而沖昏頭。" },
                    { id: "u7-23", word: "come out of", part: "phr.", chinese: "由...產生", sentence: "Nothing good came out of the argument.", sentence_ch: "這場爭論沒有產生任何好結果。" },
                    { id: "u7-24", word: "as soon as", part: "phr.", chinese: "一...就...", sentence: "Call me as soon as you arrive.", sentence_ch: "你一到就打電話給我。" }
                ],
                grammar: {
                    notes: [
                        { 
                            title: "使役動詞 (Causative Verbs)", 
                            rule: "Subject + have/has/had + Object + p.p.", 
                            desc: "此句型用來表達「使／安排某事被......」。通常表示說話者不是自己親手做，而是委託他人（如專業人士）來完成某事。關鍵在於「受詞」與「動作」之間是被動關係。", 
                            examples: [
                                "I had my hair cut. (我去剪了頭髮)", 
                                "Mr. Brown had his car fixed. (布朗先生讓人修好了他的車)",
                                "Amy had her eyes checked. (艾咪去檢查了眼睛)"
                            ] 
                        }
                    ],
                    quiz: [
                        // 1-5
                        { q: "I had my hair ______ yesterday.", options: ["cut", "cutting", "to cut"], ans: "cut", hint: "頭髮是「被剪」的 (p.p.)。" },
                        { q: "He had his car ______ last week.", options: ["fix", "fixed", "fixing"], ans: "fixed", hint: "車子是「被修理」的 (p.p.)。" },
                        { q: "We had the room ______ pink.", options: ["paint", "painted", "painting"], ans: "painted", hint: "房間是「被油漆」的 (p.p.)。" },
                        { q: "She had her nails ______ at the salon.", options: ["do", "did", "done"], ans: "done", hint: "指甲是「被做」的，do 的 p.p.。" },
                        { q: "Did you have your watch ______?", options: ["repair", "repaired", "repairing"], ans: "repaired", hint: "手錶是「被修理」的 (p.p.)。" },
                        // 6-10
                        { q: "Mom had the house ______.", options: ["clean", "cleaned", "cleaning"], ans: "cleaned", hint: "房子是「被打掃」的 (p.p.)。" },
                        { q: "I had my car ______ at the station.", options: ["wash", "washed", "washing"], ans: "washed", hint: "車子是「被洗」的 (p.p.)。" },
                        { q: "He had his eyes ______ by the doctor.", options: ["check", "checked", "checking"], ans: "checked", hint: "眼睛是「被檢查」的 (p.p.)。" },
                        { q: "They had the window ______.", options: ["break", "broke", "broken"], ans: "broken", hint: "窗戶是「被打破」的 (p.p.)。" },
                        { q: "You should have your teeth ______.", options: ["check", "checked", "checking"], ans: "checked", hint: "牙齒是「被檢查」的 (p.p.)。" },
                        // 11-15
                        { q: "We had the pizza ______ to our house.", options: ["deliver", "delivered", "delivering"], ans: "delivered", hint: "披薩是「被外送」的 (p.p.)。" },
                        { q: "She had the package ______ by air mail.", options: ["send", "sent", "sending"], ans: "sent", hint: "包裹是「被寄送」的 (p.p.)。" },
                        { q: "He had a suit ______ for the wedding.", options: ["make", "made", "making"], ans: "made", hint: "西裝是「被製作」的 (p.p.)。" },
                        { q: "I had the letter ______ in English.", options: ["write", "wrote", "written"], ans: "written", hint: "信是「被寫」的 (p.p.)。" },
                        { q: "They had the photos ______.", options: ["take", "took", "taken"], ans: "taken", hint: "照片是「被拍」的 (p.p.)。" },
                        // 16-20
                        { q: "Poor Tom had his bike ______.", options: ["steal", "stole", "stolen"], ans: "stolen", hint: "腳踏車是「被偷」的 (p.p.)。" },
                        { q: "We had the door ______ at night.", options: ["lock", "locked", "locking"], ans: "locked", hint: "門是「被鎖」的 (p.p.)。" },
                        { q: "She had her dog ______ by her neighbor.", options: ["feed", "fed", "feeding"], ans: "fed", hint: "狗是「被餵」的 (p.p.)。" },
                        { q: "He had his wallet ______ on the bus.", options: ["steal", "stole", "stolen"], ans: "stolen", hint: "錢包是「被偷」的 (p.p.)。" },
                        { q: "I had the computer ______.", options: ["fix", "fixed", "fixing"], ans: "fixed", hint: "電腦是「被修理」的 (p.p.)。" },
                        // 21-25
                        { q: "We had the work ______ by 5 PM.", options: ["finish", "finished", "finishing"], ans: "finished", hint: "工作是「被完成」的 (p.p.)。" },
                        { q: "He had the paper ______ by his father.", options: ["sign", "signed", "signing"], ans: "signed", hint: "文件是「被簽署」的 (p.p.)。" },
                        { q: "They had the machine ______.", options: ["test", "tested", "testing"], ans: "tested", hint: "機器是「被測試」的 (p.p.)。" },
                        { q: "She had the dress ______ for the party.", options: ["buy", "bought", "buying"], ans: "bought", hint: "洋裝是「被買」的 (p.p.)。" },
                        { q: "I will have the problem ______.", options: ["solve", "solved", "solving"], ans: "solved", hint: "問題是「被解決」的 (p.p.)。" },
                        // 26-30
                        { q: "Dad had the dinner ______.", options: ["cook", "cooked", "cooking"], ans: "cooked", hint: "晚餐是「被煮」的 (p.p.)。" },
                        { q: "We had some flowers ______ in the garden.", options: ["plant", "planted", "planting"], ans: "planted", hint: "花是「被種植」的 (p.p.)。" },
                        { q: "The teacher had the tests ______.", options: ["print", "printed", "printing"], ans: "printed", hint: "考卷是「被列印」的 (p.p.)。" },
                        { q: "He had his shoes ______.", options: ["clean", "cleaned", "cleaning"], ans: "cleaned", hint: "鞋子是「被擦乾淨」的 (p.p.)。" },
                        { q: "I had my homework ______.", options: ["check", "checked", "checking"], ans: "checked", hint: "作業是「被檢查」的 (p.p.)。" },
                        // 31-35 (New)
                        { q: "I had the floor ______ yesterday.", options: ["mop", "mopped", "mopping"], ans: "mopped", hint: "地板是「被拖」的 (p.p.)。" },
                        { q: "She had her bag ______ by a thief.", options: ["take", "taken", "taking"], ans: "taken", hint: "包包是「被拿走」的 (p.p.)。" },
                        { q: "We had the wall ______ blue.", options: ["paint", "painted", "painting"], ans: "painted", hint: "牆壁是「被漆」的 (p.p.)。" },
                        { q: "He had his phone ______.", options: ["charge", "charged", "charging"], ans: "charged", hint: "手機是「被充電」的 (p.p.)。" },
                        { q: "They had the grass ______.", options: ["cut", "cutting", "to cut"], ans: "cut", hint: "草是「被割」的 (p.p.)。" },
                        // 36-40
                        { q: "I had my cup ______.", options: ["fill", "filled", "filling"], ans: "filled", hint: "杯子是「被裝滿」的 (p.p.)。" },
                        { q: "She had the song ______ by a famous singer.", options: ["sing", "sung", "singing"], ans: "sung", hint: "歌是「被唱」的 (p.p.)。" },
                        { q: "We had the game ______.", options: ["start", "started", "starting"], ans: "started", hint: "遊戲是「被開始」的 (p.p.)。" },
                        { q: "He had the message ______.", options: ["read", "reading", "reads"], ans: "read", hint: "訊息是「被閱讀」的 (p.p.)。" },
                        { q: "Did you have the tickets ______?", options: ["book", "booked", "booking"], ans: "booked", hint: "票是「被預訂」的 (p.p.)。" },
                        // 41-45
                        { q: "I had the file ______.", options: ["save", "saved", "saving"], ans: "saved", hint: "檔案是「被儲存」的 (p.p.)。" },
                        { q: "She had her hair ______ red.", options: ["dye", "dyed", "dying"], ans: "dyed", hint: "頭髮是「被染」的 (p.p.)。" },
                        { q: "We had the question ______.", options: ["answer", "answered", "answering"], ans: "answered", hint: "問題是「被回答」的 (p.p.)。" },
                        { q: "He had the box ______.", options: ["open", "opened", "opening"], ans: "opened", hint: "箱子是「被打開」的 (p.p.)。" },
                        { q: "They had the road ______.", options: ["close", "closed", "closing"], ans: "closed", hint: "路是「被封閉」的 (p.p.)。" },
                        // 46-50
                        { q: "I had the apple ______.", options: ["eat", "eaten", "eating"], ans: "eaten", hint: "蘋果是「被吃」的 (p.p.)。" },
                        { q: "She had the dress ______.", options: ["wash", "washed", "washing"], ans: "washed", hint: "洋裝是「被洗」的 (p.p.)。" },
                        { q: "We had the lights ______ off.", options: ["turn", "turned", "turning"], ans: "turned", hint: "燈是「被關掉」的 (p.p.)。" },
                        { q: "He had the meeting ______.", options: ["cancel", "canceled", "canceling"], ans: "canceled", hint: "會議是「被取消」的 (p.p.)。" },
                        { q: "Did you have the mistake ______?", options: ["fix", "fixed", "fixing"], ans: "fixed", hint: "錯誤是「被修正」的 (p.p.)。" }
                    ],
                    scramble: [
                        // 1-10
                        { id: "u7-gs-1", sentence: "I had my hair cut.", sentence_ch: "我去剪了頭髮。" },
                        { id: "u7-gs-2", sentence: "She had her car fixed.", sentence_ch: "她讓人修好了她的車。" },
                        { id: "u7-gs-3", sentence: "We had the room painted.", sentence_ch: "我們讓人粉刷了房間。" },
                        { id: "u7-gs-4", sentence: "He had his watch repaired.", sentence_ch: "他讓人修理了他的手錶。" },
                        { id: "u7-gs-5", sentence: "Mom had the house cleaned.", sentence_ch: "媽媽讓人打掃了房子。" },
                        { id: "u7-gs-6", sentence: "They had the pizza delivered.", sentence_ch: "他們叫了披薩外送 (讓人送來披薩)。" },
                        { id: "u7-gs-7", sentence: "I had my eyes checked.", sentence_ch: "我去檢查了眼睛。" },
                        { id: "u7-gs-8", sentence: "He had his bike stolen.", sentence_ch: "他的腳踏車被偷了 (遭竊)。" },
                        { id: "u7-gs-9", sentence: "You should have it fixed.", sentence_ch: "你應該讓人把它修好。" },
                        { id: "u7-gs-10", sentence: "She had her picture taken.", sentence_ch: "她讓人拍了她的照片。" },
                        // 11-20
                        { id: "u7-gs-11", sentence: "We had the photos taken.", sentence_ch: "我們讓人拍了這些照片。" },
                        { id: "u7-gs-12", sentence: "He had a suit made.", sentence_ch: "他讓人訂做了一套西裝。" },
                        { id: "u7-gs-13", sentence: "I had the letter sent.", sentence_ch: "我讓人把信寄出去了。" },
                        { id: "u7-gs-14", sentence: "They had the wall painted.", sentence_ch: "他們讓人粉刷了牆壁。" },
                        { id: "u7-gs-15", sentence: "She had her nails done.", sentence_ch: "她去做了指甲 (美甲)。" },
                        { id: "u7-gs-16", sentence: "I had my homework checked.", sentence_ch: "我讓人檢查了我的作業。" },
                        { id: "u7-gs-17", sentence: "He had his shoes cleaned.", sentence_ch: "他讓人把鞋子擦乾淨了。" },
                        { id: "u7-gs-18", sentence: "We had the door locked.", sentence_ch: "我們讓人把門鎖上了 (或確保門被鎖上)。" },
                        { id: "u7-gs-19", sentence: "Did you have it done?", sentence_ch: "你讓人把它做好了嗎？" },
                        { id: "u7-gs-20", sentence: "She had the flowers planted.", sentence_ch: "她讓人種了這些花。" },
                        // 21-30
                        { id: "u7-gs-21", sentence: "I had the package sent.", sentence_ch: "我讓人寄送了包裹。" },
                        { id: "u7-gs-22", sentence: "He had his computer fixed.", sentence_ch: "他讓人修好了電腦。" },
                        { id: "u7-gs-23", sentence: "We had the food cooked.", sentence_ch: "我們讓人煮了食物。" },
                        { id: "u7-gs-24", sentence: "They had the tree cut.", sentence_ch: "他們讓人砍了那棵樹。" },
                        { id: "u7-gs-25", sentence: "She had the window broken.", sentence_ch: "她的窗戶被打破了 (遭遇)。" },
                        { id: "u7-gs-26", sentence: "I will have it finished.", sentence_ch: "我會讓人把它完成。" },
                        { id: "u7-gs-27", sentence: "He had his teeth checked.", sentence_ch: "他去檢查了牙齒。" },
                        { id: "u7-gs-28", sentence: "We had the garbage taken.", sentence_ch: "我們讓人把垃圾拿走了。" },
                        { id: "u7-gs-29", sentence: "She had the bag found.", sentence_ch: "她讓人找回了包包。" },
                        { id: "u7-gs-30", sentence: "I had the water boiled.", sentence_ch: "我讓人把水煮開了。" },
                        // 31-40 (New)
                        { id: "u7-gs-31", sentence: "I had the floor mopped.", sentence_ch: "我讓人拖了地板。" },
                        { id: "u7-gs-32", sentence: "She had the book signed.", sentence_ch: "她讓人簽了那本書。" },
                        { id: "u7-gs-33", sentence: "We had the car washed.", sentence_ch: "我們讓人洗了車。" },
                        { id: "u7-gs-34", sentence: "He had the test printed.", sentence_ch: "他讓人列印了考卷。" },
                        { id: "u7-gs-35", sentence: "They had the lunch prepared.", sentence_ch: "他們讓人準備了午餐。" },
                        { id: "u7-gs-36", sentence: "I had the key made.", sentence_ch: "我讓人打了一把鑰匙。" },
                        { id: "u7-gs-37", sentence: "She had the dog fed.", sentence_ch: "她讓人餵了狗。" },
                        { id: "u7-gs-38", sentence: "We had the problem solved.", sentence_ch: "我們讓人解決了問題。" },
                        { id: "u7-gs-39", sentence: "He had the message read.", sentence_ch: "他讓人讀了訊息。" },
                        { id: "u7-gs-40", sentence: "Did you have the tickets booked?", sentence_ch: "你讓人訂票了嗎？" },
                        // 41-50
                        { id: "u7-gs-41", sentence: "I had the file saved.", sentence_ch: "我讓人存了檔案。" },
                        { id: "u7-gs-42", sentence: "She had her hair dyed.", sentence_ch: "她讓人染了頭髮。" },
                        { id: "u7-gs-43", sentence: "We had the house built.", sentence_ch: "我們讓人蓋了這房子。" },
                        { id: "u7-gs-44", sentence: "He had the box opened.", sentence_ch: "他讓人打開了箱子。" },
                        { id: "u7-gs-45", sentence: "They had the road closed.", sentence_ch: "他們讓人封閉了道路。" },
                        { id: "u7-gs-46", sentence: "I had the cake eaten.", sentence_ch: "我讓人把蛋糕吃掉了 (或蛋糕被吃掉了)。" },
                        { id: "u7-gs-47", sentence: "She had the dress washed.", sentence_ch: "她讓人洗了洋裝。" },
                        { id: "u7-gs-48", sentence: "We had the lights turned off.", sentence_ch: "我們讓人把燈關了。" },
                        { id: "u7-gs-49", sentence: "He had the meeting canceled.", sentence_ch: "他讓人取消了會議。" },
                        { id: "u7-gs-50", sentence: "Did you have the mistake fixed?", sentence_ch: "你讓人修正錯誤了嗎？" }
                    ]
                }
            },
            unit8: {
                title: "Unit 8",
                vocab: [
                    { id: "u8-1", word: "familiar", part: "adj.", chinese: "熟悉的", sentence: "The song sounds familiar to me.", sentence_ch: "這首歌對我來說聽起來很熟悉。" },
                    { id: "u8-2", word: "urge", part: "n./vt.", chinese: "衝動；催促", sentence: "She resisted the urge to scream.", sentence_ch: "她忍住了尖叫的衝動。" },
                    { id: "u8-3", word: "strategy", part: "n.", chinese: "策略", sentence: "We need a good strategy to win the game.", sentence_ch: "我們需要好的策略來贏得比賽。" },
                    { id: "u8-4", word: "visible", part: "adj.", chinese: "看得見的", sentence: "The mountain is visible from here.", sentence_ch: "從這裡可以看見那座山。" },
                    { id: "u8-5", word: "purchase", part: "vt./n.", chinese: "購買", sentence: "He purchased a new car yesterday.", sentence_ch: "他昨天買了一輛新車。" },
                    { id: "u8-6", word: "profitable", part: "adj.", chinese: "有利潤的", sentence: "Selling coffee is a profitable business.", sentence_ch: "賣咖啡是一門有利潤的生意。" },
                    { id: "u8-7", word: "similarly", part: "adv.", chinese: "同樣地；相似地", sentence: "The two brothers dress similarly.", sentence_ch: "這兩兄弟穿著很相似。" },
                    { id: "u8-8", word: "aim", part: "vt./n.", chinese: "針對；目標", sentence: "The program aims to help poor children.", sentence_ch: "這個計畫旨在幫助貧困兒童。" },
                    { id: "u8-9", word: "impulse", part: "n.", chinese: "衝動", sentence: "I bought this candy on impulse.", sentence_ch: "我一時衝動買了這個糖果。" },
                    { id: "u8-10", word: "display", part: "vt./n.", chinese: "展示；陳列", sentence: "The museum displays many old paintings.", sentence_ch: "博物館展示了許多古畫。" },
                    { id: "u8-11", word: "offer", part: "n./vt.", chinese: "特價；提供", sentence: "He offered me a glass of water.", sentence_ch: "他提供了一杯水給我。" },
                    { id: "u8-12", word: "customer", part: "n.", chinese: "顧客", sentence: "The shop is full of customers.", sentence_ch: "這家店擠滿了顧客。" },
                    { id: "u8-13", word: "advantage", part: "n.", chinese: "優勢", sentence: "Speed is his main advantage in the race.", sentence_ch: "速度是他在比賽中的主要優勢。" },
                    { id: "u8-14", word: "eventually", part: "adv.", chinese: "最後", sentence: "It rained all day, but eventually the sun came out.", sentence_ch: "雨下了一整天，但最後太陽出來了。" },
                    { id: "u8-15", word: "trap", part: "n./vt.", chinese: "圈套；困住", sentence: "The bear was caught in a trap.", sentence_ch: "熊被捕獸夾抓住了。" },
                    { id: "u8-16", word: "aware", part: "adj.", chinese: "意識到的", sentence: "He was not aware of the mistake.", sentence_ch: "他沒有意識到那個錯誤。" },
                    { id: "u8-17", word: "clever", part: "adj.", chinese: "聰明的", sentence: "The clever boy solved the puzzle quickly.", sentence_ch: "那個聰明的男孩很快解開了謎題。" },
                    { id: "u8-18", word: "be likely to", part: "phr.", chinese: "有可能會", sentence: "It is likely to snow tonight.", sentence_ch: "今晚很可能會下雪。" },
                    { id: "u8-19", word: "within reach", part: "phr.", chinese: "在伸手可及的範圍內", sentence: "Keep the phone within reach.", sentence_ch: "把電話保持在伸手可及的範圍內。" },
                    { id: "u8-20", word: "line up", part: "phr.", chinese: "排隊", sentence: "Fans lined up to buy the tickets.", sentence_ch: "粉絲們排隊買票。" },
                    { id: "u8-21", word: "take advantage of", part: "phr.", chinese: "利用", sentence: "We should take advantage of the good weather.", sentence_ch: "我們應該好好利用這好天氣。" },
                    { id: "u8-22", word: "set up", part: "phr.", chinese: "設立；設置", sentence: "They plan to set up a new school.", sentence_ch: "他們計畫設立一所新學校。" },
                    { id: "u8-23", word: "start off", part: "phr.", chinese: "開始", sentence: "Let's start off with a warm-up exercise.", sentence_ch: "讓我們以暖身運動開始。" }
                ],
                grammar: {
                    notes: [
                        { 
                            title: "愈...愈... (Comparative)", 
                            rule: "The + Comparative ..., the + Comparative ...", 
                            desc: "此句型表示「愈……就愈……」，用兩個比較級來表達彼此在程度或數量上的密切關聯性。比較級的位置要放在 The 之後，主詞動詞之前。", 
                            examples: [
                                "The harder the wind blew, the tighter he pulled his coat. (風吹得愈大，他外套拉得愈緊)", 
                                "The more you read, the more knowledge you will get. (你讀得愈多，獲得的知識就愈多)",
                                "The sooner, the better. (愈快愈好)"
                            ] 
                        }
                    ],
                    quiz: [
                        // 1-5
                        { q: "The sooner, the ______.", options: ["better", "good", "best"], ans: "better", hint: "句型為 The + 比較級 ..., the + 比較級 ... (愈早愈好)" },
                        { q: "The more, the ______.", options: ["merrier", "merry", "merriest"], ans: "merrier", hint: "愈多愈快樂 (merry 的比較級)。" },
                        { q: "The ______ you practice, the better you get.", options: ["more", "many", "most"], ans: "more", hint: "你練習得愈多 (more)。" },
                        { q: "The less said, the ______.", options: ["better", "good", "best"], ans: "better", hint: "說得愈少愈好。" },
                        { q: "______ harder he works, the richer he becomes.", options: ["The", "A", "More"], ans: "The", hint: "句首需用 The。" },
                        // 6-10
                        { q: "The higher we go, the ______ it gets.", options: ["colder", "cold", "coldest"], ans: "colder", hint: "愈高就愈冷 (cold 的比較級)。" },
                        { q: "The faster you run, the ______ you arrive.", options: ["sooner", "soon", "soonest"], ans: "sooner", hint: "跑得愈快就愈早到達。" },
                        { q: "The hotter it is, the ______ I feel.", options: ["thirstier", "thirsty", "thirstiest"], ans: "thirstier", hint: "天氣愈熱我愈口渴。" },
                        { q: "The older he gets, the ______ he becomes.", options: ["wiser", "wise", "wisest"], ans: "wiser", hint: "年紀愈大愈有智慧。" },
                        { q: "The bigger, the ______.", options: ["better", "good", "best"], ans: "better", hint: "愈大愈好。" },
                        // 11-15
                        { q: "The more you eat, the ______ you get.", options: ["fatter", "fat", "fattest"], ans: "fatter", hint: "吃得愈多就愈胖。" },
                        { q: "The harder you study, the ______ your grades will be.", options: ["better", "good", "best"], ans: "better", hint: "愈努力讀書成績愈好。" },
                        { q: "The more you give, the ______ you receive.", options: ["more", "many", "most"], ans: "more", hint: "給予愈多，收穫愈多。" },
                        { q: "The longer you wait, the ______ you will be.", options: ["bored", "more bored", "most bored"], ans: "more bored", hint: "等待愈久愈無聊 (bored 的比較級)。" },
                        { q: "The earlier you start, the ______ you finish.", options: ["sooner", "soon", "soonest"], ans: "sooner", hint: "愈早開始愈早結束。" },
                        // 16-20
                        { q: "The ______ the question, the harder the answer.", options: ["shorter", "short", "shortest"], ans: "shorter", hint: "問題愈短，答案愈難。" },
                        { q: "The more friends you have, the ______.", options: ["happier", "happy", "happiest"], ans: "happier", hint: "朋友愈多愈快樂。" },
                        { q: "The darker the night, the ______ the stars.", options: ["brighter", "bright", "brightest"], ans: "brighter", hint: "夜愈黑星愈亮。" },
                        { q: "The more expensive the car, the ______ it is.", options: ["faster", "fast", "fastest"], ans: "faster", hint: "車愈貴跑得愈快。" },
                        { q: "The ______ you walk, the longer it takes.", options: ["slower", "slow", "slowest"], ans: "slower", hint: "走得愈慢花得時間愈長。" },
                        // 21-25
                        { q: "The more we are together, the ______ we will be.", options: ["happier", "happy", "happiest"], ans: "happier", hint: "我們愈常在一起就愈快樂。" },
                        { q: "The ______ coffee you drink, the less you sleep.", options: ["more", "many", "much"], ans: "more", hint: "喝愈多咖啡睡得愈少。" },
                        { q: "The easier the test, the ______ the score.", options: ["higher", "high", "highest"], ans: "higher", hint: "考試愈簡單分數愈高。" },
                        { q: "The ______ you climb, the better the view.", options: ["higher", "high", "highest"], ans: "higher", hint: "爬得愈高風景愈好。" },
                        { q: "The closer you look, the ______ you see.", options: ["less", "little", "least"], ans: "less", hint: "看得愈近，看到的愈少 (譬喻)。" },
                        // 26-30
                        { q: "The ______ money you save, the better.", options: ["more", "many", "much"], ans: "more", hint: "存愈多錢愈好。" },
                        { q: "The busier he is, the ______ he feels.", options: ["happier", "happy", "happiest"], ans: "happier", hint: "他愈忙愈快樂。" },
                        { q: "The ______ books you read, the smarter you become.", options: ["more", "many", "most"], ans: "more", hint: "讀愈多書愈聰明。" },
                        { q: "The simpler, the ______.", options: ["better", "good", "best"], ans: "better", hint: "愈簡單愈好。" },
                        { q: "The ______ you are, the more energy you have.", options: ["younger", "young", "youngest"], ans: "younger", hint: "愈年輕精力愈旺盛。" },
                        // 31-35 (New)
                        { q: "The safer, the ______.", options: ["better", "good", "best"], ans: "better", hint: "愈安全愈好。" },
                        { q: "The ______ you speak, the better I hear.", options: ["louder", "loud", "loudest"], ans: "louder", hint: "說得愈大聲，我聽得愈清楚。" },
                        { q: "The sweeter the candy, the ______ it is for teeth.", options: ["worse", "bad", "worst"], ans: "worse", hint: "糖果愈甜對牙齒愈不好。" },
                        { q: "The ______ the line, the longer we wait.", options: ["longer", "long", "longest"], ans: "longer", hint: "隊伍愈長，我們等愈久。" },
                        { q: "The colder the weather, the ______ clothes I wear.", options: ["more", "many", "most"], ans: "more", hint: "天氣愈冷，我穿愈多衣服。" },
                        // 36-40
                        { q: "The deeper the ocean, the ______ it is.", options: ["darker", "dark", "darkest"], ans: "darker", hint: "海洋愈深就愈暗。" },
                        { q: "The ______ you drive, the safer you are.", options: ["slower", "slow", "slowest"], ans: "slower", hint: "開得愈慢愈安全。" },
                        { q: "The more you smile, the ______ you look.", options: ["friendlier", "friendly", "friendliest"], ans: "friendlier", hint: "愈常微笑看起來愈友善。" },
                        { q: "The larger the room, the ______ space we have.", options: ["more", "many", "most"], ans: "more", hint: "房間愈大，我們有愈多空間。" },
                        { q: "The ______ the price, the better the quality.", options: ["higher", "high", "highest"], ans: "higher", hint: "價格愈高，品質愈好。" },
                        // 41-45
                        { q: "The more I sleep, the ______ I feel.", options: ["better", "good", "best"], ans: "better", hint: "睡得愈多感覺愈好。" },
                        { q: "The ______ you work, the more you earn.", options: ["harder", "hard", "hardest"], ans: "harder", hint: "工作愈努力賺得愈多。" },
                        { q: "The brighter the sun, the ______ it is.", options: ["hotter", "hot", "hottest"], ans: "hotter", hint: "太陽愈大天氣愈熱。" },
                        { q: "The ______ the road, the harder to drive.", options: ["narrower", "narrow", "narrowest"], ans: "narrower", hint: "路愈窄愈難開。" },
                        { q: "The more careful you are, the ______ mistakes you make.", options: ["fewer", "few", "fewest"], ans: "fewer", hint: "愈小心犯錯愈少。" },
                        // 46-50
                        { q: "The ______ the movie, the more I like it.", options: ["funnier", "funny", "funniest"], ans: "funnier", hint: "電影愈好笑我愈喜歡。" },
                        { q: "The more you try, the ______ success you have.", options: ["more", "many", "most"], ans: "more", hint: "嘗試愈多成功機會愈多。" },
                        { q: "The ______ the music, the better the dance.", options: ["louder", "loud", "loudest"], ans: "louder", hint: "音樂愈大聲舞跳得愈好。" },
                        { q: "The cleaner the air, the ______ we are.", options: ["healthier", "healthy", "healthiest"], ans: "healthier", hint: "空氣愈乾淨我們愈健康。" },
                        { q: "The ______ you learn, the smarter you get.", options: ["faster", "fast", "fastest"], ans: "faster", hint: "學得愈快變得愈聰明。" }
                    ],
                    scramble: [
                        // 1-10
                        { id: "u8-gs-1", sentence: "The sooner, the better.", sentence_ch: "愈快愈好。" },
                        { id: "u8-gs-2", sentence: "The more, the better.", sentence_ch: "愈多愈好。" },
                        { id: "u8-gs-3", sentence: "The more, the merrier.", sentence_ch: "愈多愈快樂 (人愈多愈熱鬧)。" },
                        { id: "u8-gs-4", sentence: "The harder you work, the luckier you get.", sentence_ch: "你愈努力，就愈幸運。" },
                        { id: "u8-gs-5", sentence: "The more you learn, the more you know.", sentence_ch: "你學得愈多，知道得愈多。" },
                        { id: "u8-gs-6", sentence: "The older he gets, the wiser he becomes.", sentence_ch: "他年紀愈大，變得愈有智慧。" },
                        { id: "u8-gs-7", sentence: "The higher we go, the colder it is.", sentence_ch: "我們爬得愈高，天氣就愈冷。" },
                        { id: "u8-gs-8", sentence: "The faster you run, the sooner you arrive.", sentence_ch: "你跑得愈快，就愈早到達。" },
                        { id: "u8-gs-9", sentence: "The more you eat, the fatter you get.", sentence_ch: "你吃得愈多，就變得愈胖。" },
                        { id: "u8-gs-10", sentence: "The less said, the better.", sentence_ch: "說得愈少愈好。" },
                        // 11-20
                        { id: "u8-gs-11", sentence: "The earlier you start, the sooner you finish.", sentence_ch: "你愈早開始，就愈早完成。" },
                        { id: "u8-gs-12", sentence: "The darker the night, the brighter the stars.", sentence_ch: "夜愈黑，星星愈亮。" },
                        { id: "u8-gs-13", sentence: "The more you give, the more you receive.", sentence_ch: "你給予愈多，得到的就愈多。" },
                        { id: "u8-gs-14", sentence: "The hotter it is, the more water I drink.", sentence_ch: "天氣愈熱，我喝愈多水。" },
                        { id: "u8-gs-15", sentence: "The bigger the dream, the harder the work.", sentence_ch: "夢想愈大，努力就要愈多。" },
                        { id: "u8-gs-16", sentence: "The easier the game, the less fun it is.", sentence_ch: "遊戲愈簡單，就愈不好玩。" },
                        { id: "u8-gs-17", sentence: "The more friends you have, the happier you are.", sentence_ch: "朋友愈多，你就愈快樂。" },
                        { id: "u8-gs-18", sentence: "The longer you wait, the more tired you become.", sentence_ch: "你等得愈久，就變得愈累。" },
                        { id: "u8-gs-19", sentence: "The more you practice, the better you play.", sentence_ch: "你練習愈多，表現得愈好。" },
                        { id: "u8-gs-20", sentence: "The closer you look, the less you see.", sentence_ch: "你靠得愈近看，看到的愈少。" },
                        // 21-30
                        { id: "u8-gs-21", sentence: "The colder it gets, the more clothes we wear.", sentence_ch: "天氣愈冷，我們穿愈多衣服。" },
                        { id: "u8-gs-22", sentence: "The cheaper the ticket, the worse the seat.", sentence_ch: "票愈便宜，座位愈差。" },
                        { id: "u8-gs-23", sentence: "The more money he has, the more he wants.", sentence_ch: "他錢愈多，想要的就愈多。" },
                        { id: "u8-gs-24", sentence: "The slower you walk, the later you will be.", sentence_ch: "你走得愈慢，就會愈晚到。" },
                        { id: "u8-gs-25", sentence: "The more you smile, the younger you look.", sentence_ch: "你愈常笑，看起來就愈年輕。" },
                        { id: "u8-gs-26", sentence: "The deeper the water, the cooler it is.", sentence_ch: "水愈深，就愈涼。" },
                        { id: "u8-gs-27", sentence: "The simpler the plan, the better it works.", sentence_ch: "計畫愈簡單，效果愈好。" },
                        { id: "u8-gs-28", sentence: "The more books you read, the smarter you get.", sentence_ch: "你讀愈多書，就變得愈聰明。" },
                        { id: "u8-gs-29", sentence: "The busier I am, the happier I feel.", sentence_ch: "我愈忙，感覺愈快樂。" },
                        { id: "u8-gs-30", sentence: "The sooner we leave, the earlier we return.", sentence_ch: "我們愈早出發，就愈早回來。" },
                        // 31-40 (New)
                        { id: "u8-gs-31", sentence: "The safer, the better.", sentence_ch: "愈安全愈好。" },
                        { id: "u8-gs-32", sentence: "The louder you speak, the better I hear.", sentence_ch: "你說得愈大聲，我聽得愈清楚。" },
                        { id: "u8-gs-33", sentence: "The sweeter the candy, the worse it is.", sentence_ch: "糖果愈甜，對牙齒愈不好。" },
                        { id: "u8-gs-34", sentence: "The longer the line, the longer we wait.", sentence_ch: "隊伍愈長，我們等愈久。" },
                        { id: "u8-gs-35", sentence: "The deeper the ocean, the darker it is.", sentence_ch: "海洋愈深，就愈暗。" },
                        { id: "u8-gs-36", sentence: "The slower you drive, the safer you are.", sentence_ch: "你開得愈慢，就愈安全。" },
                        { id: "u8-gs-37", sentence: "The larger the room, the more space we have.", sentence_ch: "房間愈大，我們有愈多空間。" },
                        { id: "u8-gs-38", sentence: "The higher the price, the better the quality.", sentence_ch: "價格愈高，品質愈好。" },
                        { id: "u8-gs-39", sentence: "The more I sleep, the better I feel.", sentence_ch: "我睡得愈多，感覺愈好。" },
                        { id: "u8-gs-40", sentence: "The harder you work, the more you earn.", sentence_ch: "你工作愈努力，賺得愈多。" },
                        // 41-50
                        { id: "u8-gs-41", sentence: "The brighter the sun, the hotter it is.", sentence_ch: "太陽愈大，天氣愈熱。" },
                        { id: "u8-gs-42", sentence: "The narrower the road, the harder to drive.", sentence_ch: "路愈窄，愈難開。" },
                        { id: "u8-gs-43", sentence: "The more careful you are, the fewer mistakes you make.", sentence_ch: "你愈小心，犯錯愈少。" },
                        { id: "u8-gs-44", sentence: "The funnier the movie, the more I like it.", sentence_ch: "電影愈好笑，我愈喜歡。" },
                        { id: "u8-gs-45", sentence: "The more you try, the more success you have.", sentence_ch: "你嘗試愈多，成功機會愈多。" },
                        { id: "u8-gs-46", sentence: "The louder the music, the better the dance.", sentence_ch: "音樂愈大聲，舞跳得愈好。" },
                        { id: "u8-gs-47", sentence: "The cleaner the air, the healthier we are.", sentence_ch: "空氣愈乾淨，我們愈健康。" },
                        { id: "u8-gs-48", sentence: "The faster you learn, the smarter you get.", sentence_ch: "你學得愈快，變得愈聰明。" },
                        { id: "u8-gs-49", sentence: "The quieter the room, the better I study.", sentence_ch: "房間愈安靜，我讀書讀得愈好。" },
                        { id: "u8-gs-50", sentence: "The more you walk, the stronger you become.", sentence_ch: "你走愈多路，變得愈強壯。" }
                    ]
                }
            },
            unit9: {
                title: "Unit 9",
                vocab: [
                    { id: "u9-1", word: "detailed", part: "adj.", chinese: "詳細的；細緻的", sentence: "The report contains detailed information.", sentence_ch: "這份報告包含詳細的資訊。" },
                    { id: "u9-2", word: "mess", part: "n.", chinese: "凌亂；髒亂", sentence: "My room is in a mess.", sentence_ch: "我的房間一團亂。" },
                    { id: "u9-3", word: "express", part: "vt.", chinese: "表達", sentence: "She expressed her thanks to the teacher.", sentence_ch: "她向老師表達了感謝。" },
                    { id: "u9-4", word: "opinion", part: "n.", chinese: "想法；意見", sentence: "What is your opinion on this matter?", sentence_ch: "你對這件事有什麼看法？" },
                    { id: "u9-5", word: "contrast", part: "vt./n.", chinese: "對比；對照", sentence: "The black cat is a sharp contrast to the snow.", sentence_ch: "這隻黑貓與雪形成強烈對比。" },
                    { id: "u9-6", word: "horror", part: "n.", chinese: "可怕；恐怖", sentence: "They watched a horror movie last night.", sentence_ch: "他們昨晚看了一部恐怖電影。" },
                    { id: "u9-7", word: "innocence", part: "n.", chinese: "無辜；純真", sentence: "He tried to prove his innocence.", sentence_ch: "他試圖證明他的清白。" },
                    { id: "u9-8", word: "violence", part: "n.", chinese: "暴力", sentence: "We must stop domestic violence.", sentence_ch: "我們必須停止家庭暴力。" },
                    { id: "u9-9", word: "visual", part: "adj.", chinese: "視覺的", sentence: "The movie has great visual effects.", sentence_ch: "這部電影有很棒的視覺效果。" },
                    { id: "u9-10", word: "pollution", part: "n.", chinese: "污染", sentence: "Air pollution is a serious problem in the city.", sentence_ch: "城市裡的空氣污染是一個嚴重的問題。" },
                    { id: "u9-11", word: "permission", part: "n.", chinese: "許可；准許", sentence: "You need permission to enter this area.", sentence_ch: "你需要許可才能進入這個區域。" },
                    { id: "u9-12", word: "effort", part: "n.", chinese: "努力", sentence: "He put a lot of effort into his work.", sentence_ch: "他投入了很多努力在他的工作上。" },
                    { id: "u9-13", word: "community", part: "n.", chinese: "社區", sentence: "We live in a friendly community.", sentence_ch: "我們住在一個友善的社區。" },
                    { id: "u9-14", word: "associate", part: "vt.", chinese: "聯想", sentence: "People associate red with passion.", sentence_ch: "人們將紅色與熱情聯想在一起。" },
                    { id: "u9-15", word: "criminal", part: "adj./n.", chinese: "犯罪的；罪犯", sentence: "Robbery is a criminal act.", sentence_ch: "搶劫是犯罪行為。" },
                    { id: "u9-16", word: "destructive", part: "adj.", chinese: "破壞性的", sentence: "The typhoon was very destructive.", sentence_ch: "這次颱風極具破壞性。" },
                    { id: "u9-17", word: "come in", part: "phr.", chinese: "具有(形狀、尺寸等)", sentence: "This shirt comes in three colors.", sentence_ch: "這件襯衫有三種顏色。" },
                    { id: "u9-18", word: "stand for", part: "phr.", chinese: "代表", sentence: "USA stands for United States of America.", sentence_ch: "USA 代表美利堅合眾國。" },
                    { id: "u9-19", word: "nothing but", part: "phr.", chinese: "只不過是；僅僅", sentence: "He did nothing but sleep all day.", sentence_ch: "他整天除了睡覺什麼也沒做。" },
                    { id: "u9-20", word: "get rid of", part: "phr.", chinese: "去除；擺脫", sentence: "I want to get rid of this old sofa.", sentence_ch: "我想要處理掉這張舊沙發。" },
                    { id: "u9-21", word: "when it comes to", part: "phr.", chinese: "當談到...", sentence: "When it comes to cooking, she is an expert.", sentence_ch: "說到烹飪，她是個專家。" }
                ],
                grammar: {
                    notes: [
                        { 
                            title: "分詞構句 (Participle Construction)", 
                            rule: "S + V..., V-ing / p.p. ...", 
                            desc: "當兩個子句由連接詞 (and) 連接且主詞相同時，可省略連接詞與主詞，將動詞改為分詞。主動(Active)改 V-ing，被動(Passive)改 p.p.。", 
                            examples: [
                                "Grace Miller tripped and fell, losing the race. (Grace 跌倒了，輸了比賽 - 主動)", 
                                "The singer stood there, surrounded by fans. (歌手站在那，被粉絲包圍 - 被動)",
                                "He walked away, singing a song. (他走開了，唱著歌 - 主動)",
                                "Written in English, the book is easy to read. (這本書用英文寫成 - 被動)"
                            ] 
                        }
                    ],
                    quiz: [
                        // 1-5
                        { q: "He walked away, ______ a song.", options: ["singing", "sang", "sung"], ans: "singing", hint: "主動動作 (唱著歌)，使用 V-ing。" },
                        { q: "______ in English, the book is easy to read.", options: ["Write", "Writing", "Written"], ans: "Written", hint: "書是「被寫」的，使用 p.p.。" },
                        { q: "She sat there, ______ by her friends.", options: ["surround", "surrounding", "surrounded"], ans: "surrounded", hint: "被朋友包圍，使用 p.p.。" },
                        { q: "______ down the street, I met an old friend.", options: ["Walking", "Walked", "Walks"], ans: "Walking", hint: "主動動作 (走在街上)，使用 V-ing。" },
                        { q: "______ the news, she started to cry.", options: ["Hearing", "Heard", "Hears"], ans: "Hearing", hint: "主動動作 (聽到消息)，使用 V-ing。" },
                        // 6-10
                        { q: "______ in Taiwan, this car is very good.", options: ["Making", "Made", "Make"], ans: "Made", hint: "車子是「被製造」的，使用 p.p.。" },
                        { q: "______ by the noise, the baby woke up.", options: ["Scaring", "Scared", "Scare"], ans: "Scared", hint: "寶寶是「被嚇醒」的，使用 p.p.。" },
                        { q: "The letter, ______ by Tom, is very long.", options: ["writing", "write", "written"], ans: "written", hint: "信是「被寫」的，使用 p.p.。" },
                        { q: "______ by mountains, the lake is beautiful.", options: ["Surrounded", "Surrounding", "Surround"], ans: "Surrounded", hint: "湖泊是「被包圍」的，使用 p.p.。" },
                        { q: "______ in 1990, the building is old.", options: ["Building", "Built", "Build"], ans: "Built", hint: "建築物是「被建造」的，使用 p.p.。" },
                        // 11-15
                        { q: "______ the dog, the cat ran away.", options: ["Seeing", "Saw", "Seen"], ans: "Seeing", hint: "貓「看見」狗 (主動)，使用 V-ing。" },
                        { q: "______ hard, he passed the test.", options: ["Studying", "Studied", "Study"], ans: "Studying", hint: "他「努力讀書」 (主動)，使用 V-ing。" },
                        { q: "______ television, I fell asleep.", options: ["Watching", "Watched", "Watch"], ans: "Watching", hint: "我「看電視」 (主動)，使用 V-ing。" },
                        { q: "______ his hand, he asked a question.", options: ["Raising", "Raised", "Raise"], ans: "Raising", hint: "他「舉手」 (主動)，使用 V-ing。" },
                        { q: "______ the door, she walked in.", options: ["Opening", "Opened", "Open"], ans: "Opening", hint: "她「開門」 (主動)，使用 V-ing。" },
                        // 16-20
                        { q: "______ by a snake, he went to the hospital.", options: ["Biting", "Bitten", "Bit"], ans: "Bitten", hint: "他「被蛇咬」 (被動)，使用 p.p.。" },
                        { q: "______ a heavy bag, she walked slowly.", options: ["Carrying", "Carried", "Carry"], ans: "Carrying", hint: "她「提著」重物 (主動)，使用 V-ing。" },
                        { q: "______ in the kitchen, Mom is cooking.", options: ["Standing", "Stood", "Stand"], ans: "Standing", hint: "媽媽「站」在廚房 (主動)，使用 V-ing。" },
                        { q: "The boy, ______ a red cap, is my brother.", options: ["wearing", "worn", "wear"], ans: "wearing", hint: "男孩「戴著」帽子 (主動)，使用 V-ing。" },
                        { q: "______ carefully, the glass won't break.", options: ["Use", "Using", "Used"], ans: "Used", hint: "玻璃杯如果「被小心使用」 (被動 - 注意主詞是玻璃杯)，使用 p.p.。" },
                        // 21-25
                        { q: "______ hungry, he ate two apples.", options: ["Feeling", "Felt", "Feel"], ans: "Feeling", hint: "他「覺得」餓 (主動)，使用 V-ing。" },
                        { q: "______ by the teacher, the student was happy.", options: ["Praising", "Praised", "Praise"], ans: "Praised", hint: "學生「被稱讚」 (被動)，使用 p.p.。" },
                        { q: "______ for the bus, I read a book.", options: ["Waiting", "Waited", "Wait"], ans: "Waiting", hint: "我「等」公車 (主動)，使用 V-ing。" },
                        { q: "______ by everyone, the song is famous.", options: ["Loving", "Loved", "Love"], ans: "Loved", hint: "歌「被喜愛」 (被動)，使用 p.p.。" },
                        { q: "______ money, he couldn't buy the ticket.", options: ["Lacking", "Lacked", "Lack"], ans: "Lacking", hint: "他「缺乏」錢 (主動)，使用 V-ing。" },
                        // 26-30
                        { q: "The car, ______ near the park, is mine.", options: ["parking", "parked", "park"], ans: "parked", hint: "車子「被停」在公園 (被動)，使用 p.p.。" },
                        { q: "______ the answer, she raised her hand.", options: ["Knowing", "Known", "Know"], ans: "Knowing", hint: "她「知道」答案 (主動)，使用 V-ing。" },
                        { q: "______ in the box, the toy was safe.", options: ["Keeping", "Kept", "Keep"], ans: "Kept", hint: "玩具「被保存」在盒子裡 (被動)，使用 p.p.。" },
                        { q: "______ loudly, the man was angry.", options: ["Shouting", "Shouted", "Shout"], ans: "Shouting", hint: "男人「大叫」 (主動)，使用 V-ing。" },
                        { q: "______ by the rain, we got wet.", options: ["Catching", "Caught", "Catch"], ans: "Caught", hint: "我們「被雨淋」 (被動 caught by...)。" },
                        // 31-35 (New)
                        { q: "______ on the sofa, she fell asleep.", options: ["Sitting", "Sat", "Sit"], ans: "Sitting", hint: "她「坐」在沙發上 (主動)，使用 V-ing。" },
                        { q: "______ by the story, the kids laughed.", options: ["Amusing", "Amused", "Amuse"], ans: "Amused", hint: "孩子「被故事逗樂」 (被動)，使用 p.p.。" },
                        { q: "______ the window, he looked out.", options: ["Opening", "Opened", "Open"], ans: "Opening", hint: "他「打開」窗戶 (主動)，使用 V-ing。" },
                        { q: "______ in 2020, the shop is new.", options: ["Opening", "Opened", "Open"], ans: "Opened", hint: "店是「被開」的 (被動)，使用 p.p.。" },
                        { q: "______ coffee, I read the news.", options: ["Drinking", "Drank", "Drink"], ans: "Drinking", hint: "我「喝」咖啡 (主動)，使用 V-ing。" },
                        // 36-40
                        { q: "The picture, ______ on the wall, is nice.", options: ["hanging", "hung", "hang"], ans: "hanging", hint: "畫「掛」在牆上 (主動狀態)，使用 V-ing。" },
                        { q: "______ by the cold, he wore a coat.", options: ["Bothering", "Bothered", "Bother"], ans: "Bothered", hint: "他「被寒冷困擾」 (被動)，使用 p.p.。" },
                        { q: "______ a bike, he went to school.", options: ["Riding", "Rode", "Ride"], ans: "Riding", hint: "他「騎」腳踏車 (主動)，使用 V-ing。" },
                        { q: "______ in the river, the fish are fast.", options: ["Swimming", "Swum", "Swim"], ans: "Swimming", hint: "魚「游」在河裡 (主動)，使用 V-ing。" },
                        { q: "The cake, ______ by Mom, is tasty.", options: ["baking", "baked", "bake"], ans: "baked", hint: "蛋糕是「被烤」的 (被動)，使用 p.p.。" },
                        // 41-45
                        { q: "______ to music, she danced.", options: ["Listening", "Listened", "Listen"], ans: "Listening", hint: "她「聽」音樂 (主動)，使用 V-ing。" },
                        { q: "______ by the sun, the ice melted.", options: ["Heating", "Heated", "Heat"], ans: "Heated", hint: "冰「被加熱」 (被動)，使用 p.p.。" },
                        { q: "______ a game, they shouted.", options: ["Playing", "Played", "Play"], ans: "Playing", hint: "他們「玩」遊戲 (主動)，使用 V-ing。" },
                        { q: "______ in the room, the cat slept.", options: ["Staying", "Stayed", "Stay"], ans: "Staying", hint: "貓「待」在房間 (主動)，使用 V-ing。" },
                        { q: "The homework, ______ yesterday, was hard.", options: ["doing", "done", "do"], ans: "done", hint: "作業是「被做」的 (被動)，使用 p.p.。" },
                        // 46-50
                        { q: "______ at the joke, he was happy.", options: ["Laughing", "Laughed", "Laugh"], ans: "Laughing", hint: "他「笑」 (主動)，使用 V-ing。" },
                        { q: "______ by the map, we found the way.", options: ["Guiding", "Guided", "Guide"], ans: "Guided", hint: "我們「被地圖指引」 (被動)，使用 p.p.。" },
                        { q: "______ early, she caught the train.", options: ["Leaving", "Left", "Leave"], ans: "Leaving", hint: "她「離開」 (主動)，使用 V-ing。" },
                        { q: "______ of the dark, he turned on the light.", options: ["Scaring", "Scared", "Scare"], ans: "Scared", hint: "他「感到害怕」 (被動意義 - be scared of)，使用 p.p.。" },
                        { q: "The phone, ______ in Japan, is cheap.", options: ["making", "made", "make"], ans: "made", hint: "手機是「被製造」的 (被動)，使用 p.p.。" }
                    ],
                    scramble: [
                        // 1-10
                        { id: "u9-gs-1", sentence: "He walked away, singing a song.", sentence_ch: "他走開了，唱著歌。" },
                        { id: "u9-gs-2", sentence: "The singer stood there, surrounded by fans.", sentence_ch: "歌手站在那，被粉絲包圍。" },
                        { id: "u9-gs-3", sentence: "Walking down the street, I met John.", sentence_ch: "走在街上時，我遇見了 John。" },
                        { id: "u9-gs-4", sentence: "Written in English, the book is easy.", sentence_ch: "因為是用英文寫的，這本書很簡單。" },
                        { id: "u9-gs-5", sentence: "Hearing the news, she cried.", sentence_ch: "聽到這消息，她哭了。" },
                        { id: "u9-gs-6", sentence: "Made in Taiwan, the computer is good.", sentence_ch: "台灣製造的電腦很好。" },
                        { id: "u9-gs-7", sentence: "Seeing the police, the thief ran away.", sentence_ch: "看到警察，小偷跑走了。" },
                        { id: "u9-gs-8", sentence: "Surrounded by water, the island is beautiful.", sentence_ch: "被水環繞，這座島嶼很美。" },
                        { id: "u9-gs-9", sentence: "Using a knife, he cut the apple.", sentence_ch: "用一把刀，他切了蘋果。" },
                        { id: "u9-gs-10", sentence: "Bitten by a dog, he went to the hospital.", sentence_ch: "被狗咬了，他去了醫院。" },
                        // 11-20
                        { id: "u9-gs-11", sentence: "Standing at the door, she waited for him.", sentence_ch: "站在門口，她等著他。" },
                        { id: "u9-gs-12", sentence: "Loved by everyone, she is happy.", sentence_ch: "被大家喜愛，她很快樂。" },
                        { id: "u9-gs-13", sentence: "Feeling hungry, I ate a banana.", sentence_ch: "覺得餓了，我吃了一根香蕉。" },
                        { id: "u9-gs-14", sentence: "Watched by his parents, the boy played well.", sentence_ch: "被父母看著，男孩表現得很好。" },
                        { id: "u9-gs-15", sentence: "Opening the window, I saw a bird.", sentence_ch: "打開窗戶，我看見一隻鳥。" },
                        { id: "u9-gs-16", sentence: "Lost in the city, he called his mom.", sentence_ch: "在城市裡迷路了，他打電話給媽媽。" },
                        { id: "u9-gs-17", sentence: "Cooking dinner, Mom cut her finger.", sentence_ch: "煮晚餐時，媽媽切到了手指。" },
                        { id: "u9-gs-18", sentence: "Cleaned every day, the room is bright.", sentence_ch: "每天被打掃，房間很明亮。" },
                        { id: "u9-gs-19", sentence: "Playing basketball, he hurt his leg.", sentence_ch: "打籃球時，他弄傷了腿。" },
                        { id: "u9-gs-20", sentence: "Born in 2000, she is young.", sentence_ch: "生於 2000 年，她很年輕。" },
                        // 21-30
                        { id: "u9-gs-21", sentence: "Driving a car, he listens to music.", sentence_ch: "開車時，他聽著音樂。" },
                        { id: "u9-gs-22", sentence: "Covered with snow, the mountain is white.", sentence_ch: "被雪覆蓋，山是白色的。" },
                        { id: "u9-gs-23", sentence: "Running fast, he caught the bus.", sentence_ch: "跑得很快，他趕上了公車。" },
                        { id: "u9-gs-24", sentence: "Used for years, the bag is old.", sentence_ch: "被使用了多年，這包包舊了。" },
                        { id: "u9-gs-25", sentence: "Smiling happily, she opened the gift.", sentence_ch: "開心地笑著，她打開了禮物。" },
                        { id: "u9-gs-26", sentence: "Painted yellow, the house looks warm.", sentence_ch: "被漆成黃色，房子看起來很溫暖。" },
                        { id: "u9-gs-27", sentence: "Working late, he felt tired.", sentence_ch: "工作到很晚，他覺得很累。" },
                        { id: "u9-gs-28", sentence: "Known as a hero, he is brave.", sentence_ch: "被稱為英雄，他很勇敢。" },
                        { id: "u9-gs-29", sentence: "Reading a book, I forgot the time.", sentence_ch: "讀著書，我忘了時間。" },
                        { id: "u9-gs-30", sentence: "Broken by the ball, the window needs fixing.", sentence_ch: "被球打破了，窗戶需要修理。" },
                        // 31-40 (New)
                        { id: "u9-gs-31", sentence: "Sitting on the sofa, she fell asleep.", sentence_ch: "坐在沙發上，她睡著了。" },
                        { id: "u9-gs-32", sentence: "Amused by the story, the kids laughed.", sentence_ch: "被故事逗樂了，孩子們笑了。" },
                        { id: "u9-gs-33", sentence: "Opening the box, he found a toy.", sentence_ch: "打開盒子，他發現了一個玩具。" },
                        { id: "u9-gs-34", sentence: "Opened in 2020, the shop is new.", sentence_ch: "2020 年開幕，這家店很新。" },
                        { id: "u9-gs-35", sentence: "Drinking coffee, I read the news.", sentence_ch: "喝著咖啡，我讀了新聞。" },
                        { id: "u9-gs-36", sentence: "Hanging on the wall, the picture is nice.", sentence_ch: "掛在牆上，那幅畫很好看。" },
                        { id: "u9-gs-37", sentence: "Bothered by the cold, he wore a coat.", sentence_ch: "受不了寒冷，他穿了大衣。" },
                        { id: "u9-gs-38", sentence: "Riding a bike, he went to school.", sentence_ch: "騎著腳踏車，他去上學。" },
                        { id: "u9-gs-39", sentence: "Swimming in the river, the fish are fast.", sentence_ch: "在河裡游，魚很快。" },
                        { id: "u9-gs-40", sentence: "Baked by Mom, the cake is tasty.", sentence_ch: "媽媽烤的，蛋糕很好吃。" },
                        // 41-50
                        { id: "u9-gs-41", sentence: "Listening to music, she danced.", sentence_ch: "聽著音樂，她跳舞。" },
                        { id: "u9-gs-42", sentence: "Heated by the sun, the ice melted.", sentence_ch: "被太陽曬熱，冰融化了。" },
                        { id: "u9-gs-43", sentence: "Playing a game, they shouted.", sentence_ch: "玩著遊戲，他們大叫。" },
                        { id: "u9-gs-44", sentence: "Staying in the room, the cat slept.", sentence_ch: "待在房間裡，貓睡覺。" },
                        { id: "u9-gs-45", sentence: "Done yesterday, the homework was hard.", sentence_ch: "昨天做的，那作業很難。" },
                        { id: "u9-gs-46", sentence: "Laughing at the joke, he was happy.", sentence_ch: "嘲笑那個笑話，他很快樂。" },
                        { id: "u9-gs-47", sentence: "Guided by the map, we found the way.", sentence_ch: "被地圖指引，我們找到了路。" },
                        { id: "u9-gs-48", sentence: "Leaving early, she caught the train.", sentence_ch: "早早離開，她趕上了火車。" },
                        { id: "u9-gs-49", sentence: "Scared of the dark, he turned on the light.", sentence_ch: "害怕黑暗，他打開了燈。" },
                        { id: "u9-gs-50", sentence: "Made in Japan, the phone is cheap.", sentence_ch: "日本製造，這手機很便宜。" }
                    ]
                }
            }
        };

        // --- 共用樣式 ---
        const GameButton = ({ children, onClick, color = "blue", className = "", disabled = false, active = false }) => {
            const colorStyles = {
                blue: "bg-sky-400 border-sky-600 text-white hover:bg-sky-300",
                green: "bg-emerald-400 border-emerald-600 text-white hover:bg-emerald-300",
                yellow: "bg-yellow-400 border-yellow-600 text-yellow-900 hover:bg-yellow-300",
                red: "bg-rose-400 border-rose-600 text-white hover:bg-rose-300",
                purple: "bg-violet-400 border-violet-600 text-white hover:bg-violet-300",
                white: "bg-white border-slate-200 text-slate-700 hover:bg-slate-50",
                gray: "bg-slate-200 border-slate-400 text-slate-600 hover:bg-slate-300",
                active: "bg-yellow-400 border-yellow-600 text-yellow-900 ring-2 ring-yellow-200 ring-offset-2",
            };
            const finalColor = active ? colorStyles.active : (colorStyles[color] || colorStyles.blue);
            return (
                <button
                onClick={onClick}
                disabled={disabled}
                className={`
                    ${finalColor} 
                    border-b-4 active:border-b-0 active:translate-y-1 
                    rounded-2xl px-4 py-2 font-black tracking-wide 
                    transition-all duration-100 shadow-md 
                    flex items-center justify-center gap-2
                    disabled:opacity-50 disabled:cursor-not-allowed disabled:active:border-b-4 disabled:active:translate-y-0
                    ${className}
                `}
                >
                {children}
                </button>
            );
        };

        // --- 元件 1: 單字學習模式 ---
        const StudyMode = ({ data }) => {
            const [mode, setMode] = useState('card');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);

            useEffect(() => {
                setCurrentIndex(0);
                setIsFlipped(false);
            }, [data]);

            if (!data || data.length === 0) return <div className="p-8 text-center text-slate-500 font-bold">目前沒有單字資料</div>;

            const currentWord = data[currentIndex];
            const handleNext = () => { setIsFlipped(false); setTimeout(() => setCurrentIndex((prev) => (prev + 1) % data.length), 200); };
            const handlePrev = () => { setIsFlipped(false); setTimeout(() => setCurrentIndex((prev) => (prev - 1 + data.length) % data.length), 200); };

            return (
                <div className="flex flex-col h-full animate-in fade-in">
                    <div className="flex justify-center mb-6 gap-3">
                        <GameButton onClick={() => setMode('card')} active={mode === 'card'} color="white" className="text-sm"><Layers className="w-4 h-4" /> 卡牌</GameButton>
                        <GameButton onClick={() => setMode('list')} active={mode === 'list'} color="white" className="text-sm"><LayoutList className="w-4 h-4" /> 列表</GameButton>
                    </div>

                    {mode === 'card' ? (
                        <div className="flex-1 flex flex-col items-center justify-start min-h-[400px]">
                            <div 
                                className="relative w-full max-w-sm h-80 cursor-pointer group perspective-1000 z-10"
                                onClick={() => setIsFlipped(!isFlipped)}
                                style={{ perspective: '1000px' }}
                            >
                                <div 
                                    className="relative w-full h-full transition-transform duration-500"
                                    style={{ transformStyle: 'preserve-3d', transform: isFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)' }}
                                >
                                    <div className="absolute inset-0 bg-white border-4 border-sky-400 rounded-3xl shadow-[0_8px_0_rgba(56,189,248,0.3)] flex flex-col items-center justify-center p-6" style={{ backfaceVisibility: 'hidden', WebkitBackfaceVisibility: 'hidden' }}>
                                        <div className="absolute top-4 right-6 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-black border-2 border-yellow-600 shadow-sm rotate-3">{currentIndex + 1} / {data.length}</div>
                                        <h2 className="text-3xl sm:text-4xl font-black text-slate-800 mb-2 tracking-tight text-center break-words w-full drop-shadow-sm">{currentWord.word}</h2>
                                        <span className="text-white bg-sky-500 font-bold px-4 py-1.5 rounded-xl text-lg shadow-md border-b-4 border-sky-700 transform -rotate-2">{currentWord.part}</span>
                                        <div className="mt-10 text-slate-400 text-xs font-bold flex items-center gap-1 animate-pulse bg-slate-100 px-3 py-1 rounded-full"><RefreshCw className="w-3 h-3" /> CLICK TO FLIP</div>
                                        <button onClick={(e) => { e.stopPropagation(); speakText(currentWord.word); }} className="absolute bottom-5 right-1/2 translate-x-1/2 p-3 bg-rose-400 text-white rounded-full border-b-4 border-rose-600 active:border-b-0 active:translate-y-1 transition-all shadow-md"><Volume2 className="w-6 h-6" /></button>
                                    </div>
                                    <div className="absolute inset-0 bg-violet-500 border-4 border-violet-700 text-white rounded-3xl shadow-[0_8px_0_rgba(109,40,217,0.3)] flex flex-col items-center justify-center p-8" style={{ backfaceVisibility: 'hidden', WebkitBackfaceVisibility: 'hidden', transform: 'rotateY(180deg)' }}>
                                        <h3 className="text-2xl sm:text-3xl font-black mb-4 text-center leading-snug drop-shadow-md bg-white/20 px-4 py-2 rounded-xl backdrop-blur-sm border-2 border-white/30 transform -rotate-1">{currentWord.chinese}</h3>
                                        <div className="bg-black/20 p-4 rounded-xl border-2 border-white/10 w-full relative overflow-y-auto max-h-[140px]">
                                            <p className="text-white text-center italic text-sm sm:text-base leading-relaxed font-bold">"{currentWord.sentence}"</p>
                                            <p className="text-violet-200 text-center text-xs mt-2 font-medium">{currentWord.sentence_ch}</p>
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); speakText(currentWord.sentence); }} className="mt-4 p-3 bg-yellow-400 text-yellow-900 rounded-full border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1 transition-all shadow-md"><Volume2 className="w-5 h-5" /></button>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-4 mt-8 w-full max-w-sm px-4">
                                <GameButton onClick={handlePrev} color="white" className="flex-1"><ChevronLeft className="w-6 h-6" /> 上一個</GameButton>
                                <GameButton onClick={handleNext} color="blue" className="flex-1 text-lg">下一個 <ChevronRight className="w-6 h-6" /></GameButton>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto max-h-[70vh] pr-1 space-y-3 pb-20">
                            {data.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-2xl border-b-4 border-slate-200 flex items-center justify-between hover:translate-x-1 transition-all group">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="font-black text-lg text-slate-700 group-hover:text-sky-500 transition-colors">{item.word}</span>
                                            <span className="text-xs text-white bg-slate-400 px-2 py-0.5 rounded-lg font-bold border-b-2 border-slate-600">{item.part}</span>
                                        </div>
                                        <div className="text-slate-500 text-sm font-bold">{item.chinese}</div>
                                    </div>
                                    <button onClick={() => speakText(item.word)} className="p-2 bg-sky-100 text-sky-500 rounded-xl hover:bg-sky-200 active:scale-95 transition-colors"><Volume2 className="w-5 h-5" /></button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- 元件 2.1: 拼字測驗 ---
        const SpellingQuiz = ({ data, onFinish }) => {
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [quizItems, setQuizItems] = useState([]);
            const [currentLetters, setCurrentLetters] = useState([]); 
            const [poolLetters, setPoolLetters] = useState([]); 
            const [feedback, setFeedback] = useState(null); 
            const [score, setScore] = useState(0);
            const [targetPattern, setTargetPattern] = useState([]); 

            useEffect(() => {
                if (!data || data.length === 0) return;
                const shuffled = shuffleArray([...data]).slice(0, 10);
                setQuizItems(shuffled);
                setCurrentQIndex(0);
                setScore(0);
                loadQuestion(shuffled[0]);
            }, [data]);

            const loadQuestion = (item) => {
                if(!item) return;
                const rawWord = item.word.toLowerCase();
                setTargetPattern(rawWord.split(''));
                const cleanChars = rawWord.replace(/[^a-z]/g, '').split('');
                const scrambled = cleanChars.map((char, idx) => ({ char, id: idx, key: `${char}-${idx}-${Math.random()}` }));
                setPoolLetters(shuffleArray([...scrambled]));
                setCurrentLetters([]);
                setFeedback(null);
                speakText(item.word);
            };

            const handlePoolClick = (l) => { if (feedback === 'correct') return; setPoolLetters(prev => prev.filter(p => p.key !== l.key)); setCurrentLetters(prev => [...prev, l]); };
            const handleAnswerClick = (l) => { if (feedback === 'correct') return; setCurrentLetters(prev => prev.filter(p => p.key !== l.key)); setPoolLetters(prev => [...prev, l]); };

            const checkAnswer = () => {
                if (feedback === 'correct') return;

                const currentItem = quizItems[currentQIndex];
                const targetWord = currentItem.word.toLowerCase().replace(/[^a-z]/g, '');
                const userWord = currentLetters.map(l => l.char).join('');
                if (userWord === targetWord) {
                    setFeedback('correct');
                    speakText("Correct! " + currentItem.word);
                    setScore(prev => prev + 10);
                    setTimeout(handleNext, 1500);
                } else {
                    setFeedback('wrong');
                    speakText("Try again");
                    setTimeout(() => setFeedback(null), 1000);
                }
            };

            const handleNext = () => {
                if (currentQIndex < quizItems.length - 1) {
                    const nextIndex = currentQIndex + 1;
                    setCurrentQIndex(nextIndex);
                    loadQuestion(quizItems[nextIndex]);
                } else {
                    onFinish(score + (feedback === 'correct' ? 10 : 0));
                }
            };

            if (!quizItems || quizItems.length === 0) return <div>Loading...</div>;
            const currentItem = quizItems[currentQIndex];
            let letterIndex = 0;

            return (
                <div className="flex flex-col items-center">
                    <div className="w-full flex justify-between items-center mb-4 px-2">
                         <span className="text-xs font-black text-slate-400">SPELLING {currentQIndex + 1} / {quizItems.length}</span>
                         <span className="text-xs font-black text-yellow-600 bg-yellow-100 px-2 py-1 rounded-lg">SCORE: {score}</span>
                    </div>
                    <div className="bg-white border-4 border-b-8 border-violet-200 rounded-3xl p-8 mb-6 text-center w-full relative shadow-sm">
                        <div className="absolute top-3 left-1/2 -translate-x-1/2 bg-violet-100 text-violet-600 px-3 py-1 rounded-lg text-xs font-black uppercase tracking-wider">Listen & Spell</div>
                        <h2 className="font-black text-3xl text-slate-800 mt-4 mb-2">{currentItem.chinese}</h2>
                        <button onClick={() => speakText(currentItem.word)} className="p-4 bg-sky-100 text-sky-500 rounded-full hover:bg-sky-200 active:scale-95 transition-colors border-4 border-sky-200"><Volume2 className="w-8 h-8" /></button>
                        <p className="mt-2 text-slate-400 text-xs font-bold">點擊喇叭聽發音</p>
                    </div>
                    <div className="relative flex flex-wrap justify-center items-end gap-2 min-h-[80px] mb-6 p-4 bg-slate-200 rounded-3xl w-full border-inner border-4 border-slate-300">
                        {targetPattern.map((char, idx) => {
                            if (/[a-z]/.test(char)) {
                                const filledLetter = currentLetters[letterIndex];
                                letterIndex++;
                                return filledLetter ? (
                                    <button key={`filled-${idx}`} onClick={() => handleAnswerClick(filledLetter)} className="w-10 h-12 bg-indigo-500 text-white rounded-lg font-black text-2xl shadow-[0_4px_0_rgb(55,48,163)] active:translate-y-1 active:shadow-none transition-all pop-in mx-[1px]">{filledLetter.char}</button>
                                ) : <div key={`empty-${idx}`} className="w-10 h-12 bg-white/50 rounded-lg border-b-4 border-slate-300 mx-[1px]"></div>;
                            } else if (char === ' ') {
                                return <div key={`space-${idx}`} className="w-6 h-12 flex items-center justify-center"></div>;
                            } else {
                                return <div key={`symbol-${idx}`} className="w-6 h-12 flex items-end justify-center pb-2 text-slate-400 font-black text-xl">{char}</div>;
                            }
                        })}
                        {currentLetters.length === 0 && <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-50"><span className="text-slate-500 font-bold text-sm bg-slate-200/80 px-2 py-1 rounded">點擊下方字母拼字</span></div>}
                    </div>
                    <div className="flex flex-wrap justify-center gap-3 mb-8">
                        {poolLetters.map((l) => (
                             <button key={l.key} onClick={() => handlePoolClick(l)} className="w-12 h-14 bg-white text-slate-700 border-b-4 border-slate-300 rounded-xl font-black text-2xl shadow-sm hover:bg-slate-50 active:border-b-0 active:translate-y-1 transition-all">{l.char}</button>
                        ))}
                    </div>
                    <div className={`w-full transition-all duration-300 ${feedback === 'wrong' ? 'animate-shake' : ''}`}>
                         <GameButton onClick={checkAnswer} color={feedback === 'correct' ? 'green' : (feedback === 'wrong' ? 'red' : 'blue')} className="w-full py-4 text-xl" disabled={currentLetters.length === 0}>
                            {feedback === 'correct' ? <><CheckCircle /> Correct!</> : (feedback === 'wrong' ? <><XCircle /> Wrong!</> : "Check Answer")}
                        </GameButton>
                    </div>
                </div>
            );
        };

        // --- 元件 2: 測驗模式 (整合) ---
        const QuizMode = ({ data, grammarData }) => {
            const [quizType, setQuizType] = useState('choice'); 
            const [status, setStatus] = useState('menu'); 
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [quizData, setQuizData] = useState([]);
            const [selectedOption, setSelectedOption] = useState(null);
            const [spellingData, setSpellingData] = useState([]);

            const startChoiceQuiz = () => {
                if (!data || data.length === 0) { alert("請先建立單字資料"); return; }
                const shuffledVocab = shuffleArray([...data]).slice(0, 15);
                const vocabQuestions = shuffledVocab.map(target => {
                    const type = Math.random() > 0.5 ? 'en-to-ch' : 'ch-to-en';
                    const distractors = shuffleArray(data.filter(w => w.id !== target.id)).slice(0, 3);
                    const options = shuffleArray([target, ...distractors]);
                    
                    return {
                        questionText: type === 'en-to-ch' ? target.word : target.chinese,
                        correctId: target.id,
                        options: options.map(o => ({
                            id: o.id,
                            text: type === 'en-to-ch' ? o.chinese : o.word,
                            isCorrect: o.id === target.id
                        })),
                        hint: type === 'en-to-ch' ? "請選出中文意思" : "請選出英文單字",
                        audio: type === 'en-to-ch' ? target.word : null
                    };
                });

                setQuizData(vocabQuestions);
                setCurrentQIndex(0);
                setScore(0);
                setSelectedOption(null);
                setQuizType('choice');
                setStatus('playing');
            };

            const startSpellingQuiz = (type) => {
                if (!data || data.length === 0) { alert("請先建立單字資料"); return; }
                let filteredData = [];
                if (type === 'words') {
                    filteredData = data.filter(item => item.part !== 'phr.');
                } else if (type === 'phrases') {
                    filteredData = data.filter(item => item.part === 'phr.');
                }

                if (filteredData.length === 0) {
                    alert("這個單元沒有這類型的題目喔！(請確認資料中的 part 欄位)");
                    return;
                }

                setSpellingData(filteredData);
                setQuizType('spelling');
                setStatus('playing');
            };

            const handleOptionClick = (option) => {
                if (selectedOption) return; 
                setSelectedOption(option);
                const currentQ = quizData[currentQIndex];
                if (currentQ.audio) speakText(currentQ.audio);
                
                if (option.isCorrect) setScore(prev => prev + 10);
            };

            const nextQuestion = () => {
                if (currentQIndex < quizData.length - 1) {
                    setCurrentQIndex(prev => prev + 1);
                    setSelectedOption(null);
                } else {
                    setStatus('result');
                }
            };

            const hasPhrases = data ? data.some(item => item.part === 'phr.') : false;
            const hasWords = data ? data.some(item => item.part !== 'phr.') : false;

            if (status === 'menu') {
                return (
                    <div className="flex flex-col items-center justify-center h-full animate-in fade-in space-y-4 pt-4 overflow-y-auto">
                        <div className="text-center mb-2"><Gamepad2 className="w-16 h-16 mx-auto text-sky-400 mb-2" /><h2 className="text-2xl font-black text-slate-700">選擇測驗模式</h2></div>
                        
                        <button onClick={startChoiceQuiz} className="w-full max-w-xs bg-white border-4 border-slate-200 p-5 rounded-3xl hover:border-sky-400 group transition-all shadow-sm hover:shadow-md text-left relative overflow-hidden">
                            <div className="absolute right-[-20px] top-[-20px] bg-sky-100 w-24 h-24 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                            <div className="relative z-10 flex items-center gap-4"><div className="bg-sky-500 text-white p-3 rounded-2xl"><MousePointerClick className="w-6 h-6" /></div><div><h3 className="text-lg font-black text-slate-800">選擇題大挑戰</h3><p className="text-xs text-slate-500 font-bold">單字 + 片語 測驗</p></div></div>
                        </button>

                        <div className="w-full max-w-xs space-y-3">
                            <div className="text-slate-400 text-xs font-black uppercase tracking-wider pl-2">Spelling Mode</div>
                            
                            {hasWords && (
                                <button onClick={() => startSpellingQuiz('words')} className="w-full bg-white border-4 border-slate-200 p-4 rounded-3xl hover:border-violet-400 group transition-all shadow-sm hover:shadow-md text-left relative overflow-hidden">
                                    <div className="absolute right-[-20px] top-[-20px] bg-violet-100 w-20 h-20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                                    <div className="relative z-10 flex items-center gap-3"><div className="bg-violet-500 text-white p-2.5 rounded-2xl"><Keyboard className="w-5 h-5" /></div><div><h3 className="text-lg font-black text-slate-800">拼字：單字篇</h3><p className="text-xs text-slate-500 font-bold">Vocabulary Only</p></div></div>
                                </button>
                            )}

                            {hasPhrases && (
                                <button onClick={() => startSpellingQuiz('phrases')} className="w-full bg-white border-4 border-slate-200 p-4 rounded-3xl hover:border-pink-400 group transition-all shadow-sm hover:shadow-md text-left relative overflow-hidden">
                                    <div className="absolute right-[-20px] top-[-20px] bg-pink-100 w-20 h-20 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                                    <div className="relative z-10 flex items-center gap-3"><div className="bg-pink-500 text-white p-2.5 rounded-2xl"><Filter className="w-5 h-5" /></div><div><h3 className="text-lg font-black text-slate-800">拼字：片語篇</h3><p className="text-xs text-slate-500 font-bold">Phrases & Idioms</p></div></div>
                                </button>
                            )}
                            
                            {!hasWords && !hasPhrases && <div className="text-slate-400 text-center text-sm">請先在資料庫填入單字以啟用拼字測驗</div>}
                        </div>
                    </div>
                );
            }

            if (status === 'result') {
                return (
                    <div className="flex flex-col items-center justify-center h-full animate-in zoom-in py-10">
                        <Trophy className="w-32 h-32 text-yellow-400 drop-shadow-xl animate-bounce" />
                        <h2 className="text-4xl font-black text-slate-800 mb-2 mt-4">任務完成！</h2>
                        <div className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-400 to-orange-500 drop-shadow-sm mb-8">{score}</div>
                        <GameButton onClick={() => setStatus('menu')} color="green" className="w-64 text-xl py-4">回到選單</GameButton>
                    </div>
                );
            }

            if (quizType === 'spelling') return <SpellingQuiz data={spellingData} onFinish={(s) => { setScore(s); setStatus('result'); }} />;

            const currentQ = quizData[currentQIndex];

            return (
                <div className="flex flex-col h-full max-w-md mx-auto">
                    <div className="mb-4 px-1 flex items-center justify-between"><div className="bg-white border-2 border-slate-200 px-3 py-1 rounded-full font-black text-slate-400 text-xs shadow-sm">STAGE {currentQIndex + 1} / {quizData.length}</div><div className="bg-yellow-100 border-2 border-yellow-300 px-3 py-1 rounded-full font-black text-yellow-700 text-xs shadow-sm">SCORE: {score}</div></div>
                    <div className="h-4 bg-slate-200 rounded-full overflow-hidden border-2 border-slate-300 mb-6 mx-1"><div className="h-full bg-gradient-to-r from-lime-400 to-emerald-500 transition-all duration-300 border-r-2 border-white/50" style={{ width: `${((currentQIndex + 1) / quizData.length) * 100}%` }}></div></div>
                    <div className="bg-white border-4 border-b-8 border-violet-200 rounded-3xl p-8 mb-6 text-center relative overflow-hidden shadow-sm group">
                        <div className="absolute top-3 left-1/2 -translate-x-1/2 bg-violet-100 text-violet-600 px-3 py-1 rounded-lg text-xs font-black uppercase tracking-wider">Question</div>
                        <h2 className="font-black text-3xl text-slate-800 mt-6 leading-relaxed">{currentQ.questionText}</h2>
                        {currentQ.audio && <button onClick={() => speakText(currentQ.audio)} className="mt-4 p-2 bg-slate-100 rounded-full text-slate-400 hover:text-violet-500 hover:bg-violet-50 border-2 border-slate-200 hover:border-violet-200 transition-colors"><Volume2 className="w-6 h-6 mx-auto" /></button>}
                    </div>
                    <div className="grid grid-cols-1 gap-3 pb-8">
                        {currentQ.options.map((option, idx) => {
                            let color = "white";
                            if (selectedOption) {
                                if (option.isCorrect) color = "green";
                                else if (selectedOption.id === option.id && !option.isCorrect) color = "red";
                            }
                            return (
                                <GameButton key={idx} disabled={!!selectedOption} onClick={() => handleOptionClick(option)} color={color} className={`justify-between py-4 text-left ${!selectedOption && "hover:bg-slate-50"}`}>
                                    <span className="text-lg">{option.text}</span>
                                    {selectedOption && option.isCorrect && <CheckCircle className="w-6 h-6 animate-bounce" />}
                                    {selectedOption && selectedOption.id === option.id && !option.isCorrect && <XCircle className="w-6 h-6 animate-pulse" />}
                                </GameButton>
                            );
                        })}
                    </div>
                    {selectedOption && <div className="fixed bottom-6 left-0 right-0 p-4 bg-transparent pointer-events-none flex justify-center z-20"><button onClick={nextQuestion} className="pointer-events-auto bg-slate-800 text-white px-8 py-4 rounded-2xl font-black text-xl shadow-2xl hover:bg-slate-900 hover:scale-105 transition-all flex items-center gap-2 animate-in slide-in-from-bottom-4 border-b-8 border-black">{currentQIndex < quizData.length - 1 ? "NEXT STAGE" : "FINISH"} <ChevronRight className="w-6 h-6" /></button></div>}
                </div>
            );
        };

        // --- 元件 3: 重組句子模式 ---
        const ScrambleMode = ({ data, titleOverride }) => {
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showResult, setShowResult] = useState(false);
            const [userSentence, setUserSentence] = useState([]); 
            const [availableWords, setAvailableWords] = useState([]); 
            const [feedback, setFeedback] = useState(null); 
            const [showGiveUpConfirm, setShowGiveUpConfirm] = useState(false); 
            const [showHelperHint, setShowHelperHint] = useState(false); 

            useEffect(() => { resetGame(); }, [data]);
        
            const resetGame = () => {
                if (!data || data.length === 0) return;
                const count = Math.min(5, data.length);
                const shuffledQuestions = shuffleArray([...data]).slice(0, count); 
                setQuestions(shuffledQuestions);
                setCurrentIndex(0);
                setScore(0);
                setShowResult(false);
                if(shuffledQuestions.length > 0) loadQuestion(shuffledQuestions[0]);
            };
        
            const loadQuestion = (question) => {
                if (!question) return;
                const rawSentence = question.sentence;
                const spacedSentence = rawSentence.replace(/([.!?])$/, ' $1');
                const words = spacedSentence.split(' ');
                const wordsWithIds = words.map((word, index) => ({ id: `${index}-${word}`, text: word }));
                setAvailableWords(shuffleArray(wordsWithIds));
                setUserSentence([]);
                setFeedback(null);
                setShowGiveUpConfirm(false);
                setShowHelperHint(false);
            };
        
            const handleSkipQuestion = () => {
                if (questions.length <= 1) return; 
                const currentQuestionIds = questions.map(q => q.id);
                const candidates = data.filter(item => !currentQuestionIds.includes(item.id));
                let newQuestion;
                if (candidates.length > 0) {
                    newQuestion = candidates[Math.floor(Math.random() * candidates.length)];
                } else {
                    const otherQuestions = data.filter(item => item.id !== questions[currentIndex].id);
                    newQuestion = otherQuestions[Math.floor(Math.random() * otherQuestions.length)];
                }
                const newQuestions = [...questions];
                newQuestions[currentIndex] = newQuestion;
                setQuestions(newQuestions);
                loadQuestion(newQuestion);
            };

            const handleWordClick = (wordObj) => { if (feedback === 'correct') return; if (feedback === 'wrong') setFeedback(null); setAvailableWords(prev => prev.filter(w => w.id !== wordObj.id)); setUserSentence(prev => [...prev, wordObj]); };
            const handleAnswerClick = (wordObj) => { if (feedback === 'correct') return; if (feedback === 'wrong') setFeedback(null); setUserSentence(prev => prev.filter(w => w.id !== wordObj.id)); setAvailableWords(prev => [...prev, wordObj]); };
            const handleTryAgain = () => { setFeedback(null); setShowHelperHint(true); setTimeout(() => setShowHelperHint(false), 5000); };
            const handleMagicHint = () => {
                if (feedback === 'correct') return;
                setFeedback(null); 
                let firstWrongIndex = -1;
                for (let i = 0; i < userSentence.length; i++) { if (!userSentence[i].id.startsWith(`${i}-`)) { firstWrongIndex = i; break; } }
                if (firstWrongIndex === -1) firstWrongIndex = userSentence.length;
                const totalWords = userSentence.length + availableWords.length;
                if (firstWrongIndex >= totalWords) return;
                const correctPart = userSentence.slice(0, firstWrongIndex);
                const wrongPart = userSentence.slice(firstWrongIndex);
                const targetIdPrefix = `${firstWrongIndex}-`;
                let nextWordObj = wrongPart.find(w => w.id.startsWith(targetIdPrefix));
                let newAvailable = [...availableWords];
                if (nextWordObj) {
                    const others = wrongPart.filter(w => w.id !== nextWordObj.id);
                    newAvailable = [...newAvailable, ...others];
                } else {
                    nextWordObj = availableWords.find(w => w.id.startsWith(targetIdPrefix));
                    if (nextWordObj) {
                        newAvailable = newAvailable.filter(w => w.id !== nextWordObj.id);
                        newAvailable = [...newAvailable, ...wrongPart];
                    }
                }
                if (nextWordObj) {
                    setUserSentence([...correctPart, nextWordObj]);
                    setAvailableWords(newAvailable);
                    speakText(nextWordObj.text);
                }
            };

            const handleGiveUpClick = () => { setFeedback(null); setShowGiveUpConfirm(true); };
            const confirmGiveUp = () => {
                const allWords = [...userSentence, ...availableWords];
                allWords.sort((a, b) => { const indexA = parseInt(a.id.split('-')[0]); const indexB = parseInt(b.id.split('-')[0]); return indexA - indexB; });
                setUserSentence(allWords);
                setAvailableWords([]);
                setFeedback('correct'); 
                setShowGiveUpConfirm(false);
            };

            const checkAnswer = () => {
                const currentQuestion = questions[currentIndex];
                const targetSentence = currentQuestion.sentence.replace(/\s+([.!?])/g, '$1'); 
                const userRawString = userSentence.map(w => w.text).join(' ');
                const userCleanString = userRawString.replace(/\s+([.!?])/g, '$1');
                if (userCleanString === targetSentence) { 
                    if (feedback === 'correct') return;
                    setFeedback('correct'); 
                    setScore(prev => prev + 20); 
                    speakText(currentQuestion.sentence); 
                } else { 
                    setFeedback('wrong'); 
                    speakText("Oops"); 
                }
            };
            const nextQuestion = () => { if (currentIndex < questions.length - 1) { setCurrentIndex(prev => prev + 1); loadQuestion(questions[currentIndex + 1]); } else { setShowResult(true); } };

            if (!questions || questions.length === 0) return <div className="p-10 text-center font-bold text-slate-400">請確認有足夠的單字例句資料</div>;
            if (showResult) return (
                <div className="flex flex-col items-center justify-center h-full animate-in zoom-in py-10 relative overflow-hidden">
                    <Star className="w-32 h-32 text-yellow-400 mb-6 fill-yellow-400 drop-shadow-[0_4px_0_rgba(234,179,8,1)] animate-bounce" />
                    <h2 className="text-4xl font-black text-slate-800 mb-2 tracking-tight">挑戰成功！</h2>
                    <div className="text-7xl font-black text-indigo-600 mb-8 drop-shadow-sm">{score}</div>
                    <GameButton onClick={resetGame} color="purple" className="w-64 py-4 text-xl"><RefreshCw className="w-6 h-6" /> 再玩一次</GameButton>
                </div>
            );
        
            const currentQ = questions[currentIndex];
            return (
            <div className="flex flex-col h-full max-w-2xl mx-auto pb-24 relative">
                <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0 opacity-30"><div className="absolute top-10 left-10 text-yellow-300"><Star size={40} /></div><div className="absolute top-40 right-10 text-rose-300"><Puzzle size={50} /></div><div className="absolute bottom-20 left-20 text-sky-300"><Gamepad2 size={60} /></div></div>
                <div className="bg-white border-4 border-b-8 border-orange-200 rounded-3xl p-6 mb-6 text-center relative z-10 shadow-sm">
                    <div className="flex justify-between items-center mb-2">
                        <div className="inline-block bg-orange-100 text-orange-600 font-black px-3 py-1 rounded-lg text-xs border-2 border-orange-200">{titleOverride ? titleOverride : `LEVEL ${currentIndex + 1}`}</div>
                        {currentQ?.word && <div className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">Target: {currentQ.word}</div>}
                    </div>
                    <h2 className="font-black text-2xl text-slate-800 mb-4 leading-relaxed drop-shadow-sm">{currentQ?.sentence_ch}</h2>
                    <p className="text-orange-500 text-sm font-bold bg-orange-50 px-4 py-1.5 rounded-full inline-block border-2 border-orange-100 animate-pulse">請用下方的積木拼出這句英文</p>
                </div>
                <div className="bg-slate-200/50 rounded-3xl shadow-inner border-4 border-slate-300 min-h-[160px] p-5 mb-6 flex flex-wrap content-center justify-center gap-3 relative transition-all z-10">
                    {userSentence.length === 0 && <div className="text-slate-400 font-black pointer-events-none flex flex-col items-center"><Puzzle className="w-10 h-10 mb-2 opacity-50" />請依序點擊下方的英文單字</div>}
                    {userSentence.map((wordObj) => (<button key={wordObj.id} onClick={() => handleAnswerClick(wordObj)} className="bg-indigo-500 text-white px-4 py-3 rounded-xl font-bold shadow-[0_4px_0_rgb(55,48,163)] active:shadow-none active:translate-y-1 transition-all border-2 border-indigo-400 text-lg animate-in zoom-in">{wordObj.text}</button>))}
                </div>
                <div className="h-20 mb-4 flex items-center justify-center gap-3 z-10 relative">
                    {feedback === 'correct' ? (
                        <div className="w-full bg-emerald-100 border-4 border-emerald-300 text-emerald-700 px-6 py-4 rounded-3xl flex items-center justify-between shadow-lg animate-in slide-in-from-bottom-2">
                            <div className="flex items-center gap-2 font-black text-xl"><CheckCircle className="w-8 h-8 text-emerald-500" /> CORRECT!</div>
                            <GameButton onClick={nextQuestion} color="green" className="text-sm">NEXT <ChevronRight className="w-4 h-4" /></GameButton>
                        </div>
                    ) : feedback === 'wrong' ? (
                        <div className="w-full flex justify-center animate-in shake">
                            <button onClick={handleTryAgain} className="bg-rose-500 text-white border-b-4 border-rose-700 active:border-b-0 active:translate-y-1 px-8 py-3 rounded-2xl font-black text-xl shadow-xl flex items-center gap-2 hover:bg-rose-600 transition-all w-full justify-center"><XCircle className="w-8 h-8" /> TRY AGAIN! (點擊重試)</button>
                        </div>
                    ) : (
                        <>
                        <div className="flex gap-2 relative">
                                {showHelperHint && <div className="absolute -top-20 left-0 bg-white border-4 border-sky-400 p-3 rounded-2xl w-48 shadow-xl z-50 animate-in fade-in slide-in-from-bottom-2"><p className="text-sky-600 text-xs font-black mb-1">💡 卡關了嗎？</p><p className="text-slate-600 text-xs font-bold">試試左邊的魔法棒或投降旗幟喔！</p><div className="absolute -bottom-3 left-6 w-4 h-4 bg-white border-b-4 border-r-4 border-sky-400 transform rotate-45"></div></div>}
                                <GameButton onClick={handleSkipQuestion} color="purple" className="py-4" title="換一題"><Shuffle className="w-6 h-6" /></GameButton>
                                <GameButton onClick={handleMagicHint} color="yellow" className="py-4" title="提示下一個字"><Wand2 className="w-6 h-6" /></GameButton>
                                <GameButton onClick={handleGiveUpClick} color="red" className="py-4" title="查看答案"><Flag className="w-6 h-6" /></GameButton>
                        </div>
                        <GameButton onClick={checkAnswer} disabled={userSentence.length === 0} color="blue" className="flex-1 py-4 text-xl shadow-lg"><CheckCircle className="w-6 h-6" /> 檢查</GameButton>
                        </>
                    )}
                </div>
                <div className="flex flex-wrap gap-2 justify-center z-10 relative pb-4">
                    {availableWords.map((wordObj) => (<button key={wordObj.id} onClick={() => handleWordClick(wordObj)} className="bg-white text-slate-700 px-5 py-3 rounded-xl font-bold shadow-[0_4px_0_rgb(203,213,225)] active:shadow-none active:translate-y-1 transition-all border-2 border-slate-200 text-lg hover:border-indigo-300 hover:text-indigo-600">{wordObj.text}</button>))}
                </div>
                {showGiveUpConfirm && (
                    <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm rounded-3xl animate-in fade-in">
                        <div className="bg-white p-6 rounded-3xl border-4 border-slate-200 shadow-2xl max-w-xs text-center transform scale-100 animate-in zoom-in">
                            <div className="flex justify-center mb-4"><AlertCircle className="w-16 h-16 text-yellow-400" /></div>
                            <h3 className="text-2xl font-black text-slate-800 mb-2">Wait!</h3>
                            <p className="text-slate-500 font-bold mb-6">真的不自己再試試看嗎？<br/>自己拼出來會很有成就感喔！</p>
                            <div className="flex gap-3 justify-center">
                                <GameButton onClick={() => setShowGiveUpConfirm(false)} color="blue" className="text-sm">再試一次</GameButton>
                                <GameButton onClick={confirmGiveUp} color="gray" className="text-sm">我看答案</GameButton>
                            </div>
                        </div>
                    </div>
                )}
            </div>
            );
        };

        // --- 元件 4: 文法模式 ---
        const GrammarMode = ({ grammarData }) => {
            const [mode, setMode] = useState('notes'); // 'notes', 'quiz', 'scramble'
            const [currentQuizIndex, setCurrentQuizIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showResult, setShowResult] = useState(false);
            const [selectedOption, setSelectedOption] = useState(null);
            const [quizList, setQuizList] = useState([]);

            const prepareQuizData = (rawList) => {
                if(!rawList) return [];
                return rawList.map(item => ({
                    ...item,
                    options: shuffleArray([...item.options]) 
                }));
            };

            useEffect(() => {
                if (grammarData?.quiz) { 
                    const raw = shuffleArray([...grammarData.quiz]).slice(0, 10);
                    setQuizList(prepareQuizData(raw)); 
                }
                setMode('notes');
                setCurrentQuizIndex(0);
                setScore(0);
                setShowResult(false);
                setSelectedOption(null);
            }, [grammarData]);

            const handleOptionClick = (option, correctAns) => {
                if (selectedOption) return;
                setSelectedOption(option);
                if (option === correctAns) { setScore(prev => prev + 10); speakText("Correct"); } else { speakText("Wrong"); }
            };

            const nextQuestion = () => {
                if (currentQuizIndex < quizList.length - 1) { setCurrentQuizIndex(prev => prev + 1); setSelectedOption(null); } else { setShowResult(true); }
            };

            const restartQuiz = () => {
                const raw = shuffleArray([...grammarData.quiz]).slice(0, 10);
                setQuizList(prepareQuizData(raw));
                setCurrentQuizIndex(0);
                setScore(0);
                setShowResult(false);
                setSelectedOption(null);
            };

            if (!grammarData || !grammarData.notes) return <div className="p-8 text-center text-slate-400 font-bold">目前沒有文法資料</div>;

            return (
                <div className="flex flex-col h-full animate-in fade-in">
                    <div className="flex justify-center mb-6 gap-2">
                        <GameButton onClick={() => setMode('notes')} active={mode === 'notes'} color="white" className="text-sm px-3"><PenTool className="w-4 h-4" /> 筆記</GameButton>
                        <GameButton onClick={() => setMode('quiz')} active={mode === 'quiz'} color="white" className="text-sm px-3"><CheckCircle className="w-4 h-4" /> 挑戰</GameButton>
                        <GameButton onClick={() => setMode('scramble')} active={mode === 'scramble'} color="white" className="text-sm px-3"><Puzzle className="w-4 h-4" /> 句型重組</GameButton>
                    </div>

                    {mode === 'notes' && (
                        <div className="flex-1 overflow-y-auto pb-20 space-y-4">
                            {grammarData.notes.map((note, idx) => (
                                <div key={idx} className="bg-white border-4 border-slate-200 rounded-3xl p-6 shadow-sm hover:border-indigo-300 transition-colors">
                                    <h3 className="text-xl font-black text-indigo-600 mb-2 flex items-center gap-2"><div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 text-sm">{idx+1}</div>{note.title}</h3>
                                    <div className="bg-slate-100 p-3 rounded-xl font-bold text-slate-700 mb-3 border-l-4 border-slate-400">{note.rule}</div>
                                    <p className="text-slate-500 text-sm mb-4 font-bold">{note.desc}</p>
                                    <div className="space-y-2">{note.examples.map((ex, i) => (<div key={i} className="flex gap-2 text-slate-600 text-sm font-medium"><span className="text-green-500 font-bold">✓</span> {ex}</div>))}</div>
                                </div>
                            ))}
                        </div>
                    )}
                    {mode === 'scramble' && <ScrambleMode data={grammarData.scramble || []} titleOverride="GRAMMAR SCRAMBLE" />}
                    {mode === 'quiz' && (
                        showResult ? (
                            <div className="flex flex-col items-center justify-center h-full animate-in zoom-in py-10">
                                <Trophy className="w-24 h-24 text-yellow-400 drop-shadow-lg mb-4" />
                                <h2 className="text-3xl font-black text-slate-800 mb-2">文法大師！</h2>
                                <div className="text-6xl font-black text-indigo-600 mb-8">{score}</div>
                                <GameButton onClick={restartQuiz} color="green" className="w-48 text-lg">再測驗一次</GameButton>
                            </div>
                        ) : (
                            <div className="flex flex-col h-full max-w-md mx-auto relative">
                                {quizList.length > 0 && (
                                    <>
                                        <div className="mb-4 flex justify-between items-center px-1">
                                            <span className="text-xs font-black text-slate-400 uppercase tracking-wider">Question {currentQuizIndex + 1} / {quizList.length}</span>
                                            <span className="text-xs font-black text-yellow-600 bg-yellow-100 px-2 py-1 rounded-lg">SCORE: {score}</span>
                                        </div>
                                        <div className="bg-white border-4 border-b-8 border-indigo-200 rounded-3xl p-6 mb-4 min-h-[140px] flex items-center justify-center text-center shadow-sm relative">
                                            <h3 className="text-xl font-black text-slate-700 leading-relaxed">
                                                {quizList[currentQuizIndex].q.split('______').map((part, i, arr) => (
                                                    <React.Fragment key={i}>
                                                        {part}
                                                        {i < arr.length - 1 && <span className="inline-block min-w-[60px] border-b-4 border-indigo-400 mx-1 text-indigo-600">{selectedOption === quizList[currentQuizIndex].ans ? quizList[currentQuizIndex].ans : "?"}</span>}
                                                    </React.Fragment>
                                                ))}
                                            </h3>
                                            {selectedOption && <div className="absolute -bottom-4 bg-indigo-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-sm animate-in fade-in slide-in-from-bottom-1">Hint: {quizList[currentQuizIndex].hint}</div>}
                                        </div>
                                        <div className="grid grid-cols-1 gap-3">
                                            {quizList[currentQuizIndex].options.map((opt, idx) => {
                                                const isCorrect = opt === quizList[currentQuizIndex].ans;
                                                let btnColor = "white";
                                                if (selectedOption) {
                                                    if (isCorrect) btnColor = "green";
                                                    else if (selectedOption === opt) btnColor = "red";
                                                }
                                                return (
                                                    <GameButton key={idx} onClick={() => handleOptionClick(opt, quizList[currentQuizIndex].ans)} disabled={!!selectedOption} color={btnColor} className="py-3 text-lg justify-between">
                                                        {opt}
                                                        {selectedOption && isCorrect && <CheckCircle className="w-5 h-5" />}
                                                        {selectedOption === opt && !isCorrect && <XCircle className="w-5 h-5" />}
                                                    </GameButton>
                                                )
                                            })}
                                        </div>
                                        {selectedOption && <div className="mt-6 flex justify-center"><GameButton onClick={nextQuestion} color="blue" className="w-full text-lg py-3 animate-in slide-in-from-bottom-2">{currentQuizIndex < quizList.length - 1 ? "下一題" : "看成績"} <ChevronRight className="w-5 h-5" /></GameButton></div>}
                                    </>
                                )}
                                {quizList.length === 0 && <div className="p-10 text-center font-bold text-slate-400">請確認有足夠的文法題目</div>}
                            </div>
                        )
                    )}
                </div>
            );
        };

        // --- Main App Container ---
        function Unit34App() {
            const [activeTab, setActiveTab] = useState('study');
            const [currentUnit, setCurrentUnit] = useState('unit7'); 

            const unitTitle = UNITS_DATA[currentUnit].title;
            const unitData = UNITS_DATA[currentUnit].vocab;
            const unitGrammar = UNITS_DATA[currentUnit].grammar;

            useEffect(() => { document.body.classList.add('loaded'); }, []);

            return (
                <div className="min-h-screen font-sans text-slate-800 flex flex-col bg-sky-50 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]">
                <div className="bg-white/90 backdrop-blur-sm sticky top-0 z-50 border-b-4 border-slate-200">
                    <div className="max-w-md mx-auto px-4 py-3">
                    <div className="flex justify-between items-center mb-3 bg-slate-100 p-2 rounded-2xl border-2 border-slate-200">
                        <div className="flex items-center gap-2 font-black text-slate-600 text-lg tracking-tight ml-2"><Map className="w-6 h-6 text-sky-500" /><span>MAP</span></div>
                        <div className="flex gap-2">
                            {['unit7', 'unit8', 'unit9'].map(uKey => (
                            <button key={uKey} onClick={() => setCurrentUnit(uKey)} className={`px-3 py-1 text-xs sm:text-sm font-black rounded-xl transition-all border-b-4 active:border-b-0 active:translate-y-1 ${currentUnit === uKey ? 'bg-sky-500 border-sky-700 text-white shadow-sky-200' : 'bg-white border-slate-300 text-slate-400 hover:bg-slate-50'}`}>{UNITS_DATA[uKey].title}</button>
                            ))}
                        </div>
                    </div>
                    <div className="grid grid-cols-4 gap-2">
                        <GameButton onClick={() => setActiveTab('study')} active={activeTab === 'study'} color={activeTab === 'study' ? 'active' : 'white'} className="text-xs py-3 px-1"><Layers className="w-3 h-3 md:w-4 md:h-4" /> 學習</GameButton>
                        <GameButton onClick={() => setActiveTab('quiz')} active={activeTab === 'quiz'} color={activeTab === 'quiz' ? 'active' : 'white'} className="text-xs py-3 px-1"><CheckCircle className="w-3 h-3 md:w-4 md:h-4" /> 測驗</GameButton>
                        <GameButton onClick={() => setActiveTab('sentences')} active={activeTab === 'sentences'} color={activeTab === 'sentences' ? 'active' : 'white'} className="text-xs py-3 px-1"><Puzzle className="w-3 h-3 md:w-4 md:h-4" /> 重組</GameButton>
                        <GameButton onClick={() => setActiveTab('grammar')} active={activeTab === 'grammar'} color={activeTab === 'grammar' ? 'active' : 'white'} className="text-xs py-3 px-1"><GraduationCap className="w-3 h-3 md:w-4 md:h-4" /> 文法</GameButton>
                    </div>
                    </div>
                </div>
                <div className="flex-1 max-w-md mx-auto w-full p-4 pt-6">
                    <div className="mb-6 text-center"><span className="inline-flex items-center gap-2 bg-slate-800 text-white text-xs font-black px-4 py-1.5 rounded-full border-2 border-slate-600 shadow-md"><Map className="w-3 h-3 text-yellow-400" />目前關卡：{unitTitle}</span></div>
                    {activeTab === 'study' && <StudyMode data={unitData} />}
                    {activeTab === 'quiz' && <QuizMode data={unitData} grammarData={unitGrammar} />}
                    {activeTab === 'sentences' && <ScrambleMode data={unitData} />}
                    {activeTab === 'grammar' && <GrammarMode grammarData={unitGrammar} />}
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Unit34App />);
    </script>
</body>
</html>
